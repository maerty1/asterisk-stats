<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css?v=<%= staticVersion %>">
  <script src="/js/status-monitor.js?v=<%= staticVersion %>"></script>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo-icon">üèÜ</div>
          <div class="logo-text">
            <h1>–†–µ–π—Ç–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π</h1>
            <div class="logo-subtitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</div>
          </div>
        </div>
        <div class="header-status-group">
          <a href="/" class="btn btn-secondary">
            <span>‚Üê</span> –ù–∞–∑–∞–¥ –∫ –æ—Ç—á–µ—Ç–∞–º
          </a>
          <div class="performance-indicator" id="system-status">
            <span id="status-indicator">‚óè</span>
            <span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>
          <div class="tech-metric" id="current-time"><%= new Date().toLocaleTimeString('ru-RU') %></div>
        </div>
      </div>
      
      <div class="header-form-container">
        <form method="POST" action="/rankings" id="rankings-form">
          <div class="form-row" style="grid-template-columns: repeat(6, 1fr);">
            <div class="form-group">
              <label for="start_date">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</label>
              <input type="date" id="start_date" name="start_date" value="<%= startDate %>" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="end_date">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</label>
              <input type="date" id="end_date" name="end_date" value="<%= endDate %>" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="sortBy">–ö—Ä–∏—Ç–µ—Ä–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
              <select id="sortBy" name="sortBy">
                <option value="composite" <%= sortBy === 'composite' ? 'selected' : '' %>>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                <option value="answerRate" <%= sortBy === 'answerRate' ? 'selected' : '' %>>–ü–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –æ—Ç–≤–µ—Ç–∞</option>
                <option value="sla" <%= sortBy === 'sla' ? 'selected' : '' %>>–ü–æ SLA (20 —Å–µ–∫)</option>
                <option value="volume" <%= sortBy === 'volume' ? 'selected' : '' %>>–ü–æ –æ–±—ä–µ–º—É –∑–≤–æ–Ω–∫–æ–≤</option>
                <option value="abandonRate" <%= sortBy === 'abandonRate' ? 'selected' : '' %>>–ü–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö</option>
                <option value="asa" <%= sortBy === 'asa' ? 'selected' : '' %>>–ü–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞</option>
              </select>
            </div>
            <div class="form-group">
              <label for="departmentFilter">–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ç–¥–µ–ª—É</label>
              <select id="departmentFilter" name="departmentFilter">
                <option value="">–í—Å–µ –æ—Ç–¥–µ–ª—ã</option>
                <option value="OP" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'OP') ? 'selected' : '' %>>–û–ü</option>
                <option value="Recepcia" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'Recepcia') ? 'selected' : '' %>>–†–µ—Ü–µ–ø—Ü–∏—è</option>
                <option value="Kommun" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'Kommun') ? 'selected' : '' %>>–ö–æ–º–º—É–Ω —Ü–µ–Ω—Ç—Ä</option>
              </select>
            </div>
            <div class="form-group">
              <label style="visibility: hidden;">–î–µ–π—Å—Ç–≤–∏—è</label>
              <div style="display: flex; gap: var(--space-2);">
                <button type="button" class="btn btn-primary" id="show-rankings-btn" style="flex: 1;">
                  <span>‚ñ∂</span> –ü–æ–∫–∞–∑–∞—Ç—å
                </button>
                <button type="button" class="btn btn-secondary" id="export-rankings-btn" title="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö">
                  <span>üì•</span>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </header>

    <main>
      <!-- Loading state -->
      <div id="loading-message" class="loading-state" style="display: block;">
        <div class="spinner"></div>
        <p class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</p>
      </div>

      <!-- Error state -->
      <div id="error-message" class="card" style="display: none; border-color: var(--accent-error);">
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <h3 class="empty-state-title">–û—à–∏–±–∫–∞</h3>
          <p class="empty-state-description" id="error-text"></p>
        </div>
      </div>

      <!-- Rankings results -->
      <section id="rankings-results" style="display: none;">
        <div class="table-container">
          <div class="table-header">
            <h2 class="table-title" id="rankings-title">
              <span>üìä</span> –†–µ–π—Ç–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π
            </h2>
            <div class="table-actions export-actions">
              <button class="btn btn-secondary export-btn excel" id="export-excel-inline" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel">
                üì• Excel
              </button>
            </div>
          </div>
          <div class="table-scroll">
            <table class="rankings-table" id="rankings-table">
              <thead>
                <tr>
                  <th class="cell-center" style="width: 70px;">–†–∞–Ω–≥</th>
                  <th>–û—á–µ—Ä–µ–¥—å</th>
                  <th>–û—Ç–¥–µ–ª</th>
                  <th class="cell-center">–ó–≤–æ–Ω–∫–æ–≤</th>
                  <th class="cell-center">–û—Ç–≤–µ—Ç</th>
                  <th class="cell-center">SLA</th>
                  <th class="cell-center">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</th>
                  <th class="cell-center">ASA</th>
                  <th class="cell-center">–†–µ–π—Ç–∏–Ω–≥</th>
                </tr>
              </thead>
              <tbody id="rankings-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞—Ç –≤ sessionStorage
    function saveDateRange() {
      const startDateInput = document.getElementById('start_date');
      const endDateInput = document.getElementById('end_date');
      if (startDateInput && endDateInput) {
        const dateRange = {
          startDate: startDateInput.value || '',
          endDate: endDateInput.value || ''
        };
        sessionStorage.setItem('asteriskStatsDateRange', JSON.stringify(dateRange));
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç –∏–∑ sessionStorage
    function restoreDateRange() {
      try {
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞—Ç—ã –≤ –ø–æ–ª—è—Ö —Ñ–æ—Ä–º—ã (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–µ—Ä–≤–µ—Ä–æ–º)
        const hasServerDates = (startDateInput && startDateInput.value) || (endDateInput && endDateInput.value);
        
        // –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–µ—Ä–≤–µ—Ä–æ–º, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ sessionStorage
        if (!hasServerDates) {
          const saved = sessionStorage.getItem('asteriskStatsDateRange');
          if (saved) {
            const dateRange = JSON.parse(saved);
            if (startDateInput && dateRange.startDate) {
              startDateInput.value = dateRange.startDate;
            }
            if (endDateInput && dateRange.endDate) {
              endDateInput.value = dateRange.endDate;
            }
          }
        } else {
          // –ï—Å–ª–∏ –¥–∞—Ç—ã –µ—Å—Ç—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –≤ sessionStorage
          saveDateRange();
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç:', e);
      }
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
      restoreDateRange();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
      const startDateInput = document.getElementById('start_date');
      const endDateInput = document.getElementById('end_date');
      
      if (startDateInput) {
        startDateInput.addEventListener('change', saveDateRange);
      }
      if (endDateInput) {
        endDateInput.addEventListener('change', saveDateRange);
      }
    });
    
    // Show Rankings button
    document.getElementById('show-rankings-btn').addEventListener('click', () => {
      document.getElementById('rankings-form').dispatchEvent(
        new Event('submit', { bubbles: true, cancelable: true })
      );
    });
    
    // Form submit handler
    document.getElementById('rankings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        sortBy: formData.get('sortBy') || 'composite',
        departmentFilter: formData.get('departmentFilter') || null
      };
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      saveDateRange();
      
      // Show loading
      document.getElementById('loading-message').style.display = 'flex';
      document.getElementById('rankings-results').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
      
      try {
        const response = await fetch('/rankings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success && result.rankings?.length > 0) {
          displayRankings(result.rankings, result.sortBy, result.period);
        } else {
          throw new Error(result.error || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥');
        }
      } catch (error) {
        document.getElementById('error-text').textContent = error.message;
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('loading-message').style.display = 'none';
      }
    });

    function displayRankings(rankings, sortBy, period) {
      const sortLabels = {
        composite: '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥',
        answerRate: '–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞',
        sla: 'SLA (20 —Å–µ–∫)',
        volume: '–û–±—ä–µ–º –∑–≤–æ–Ω–∫–æ–≤',
        abandonRate: '–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ',
        asa: '–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞'
      };
      
      document.getElementById('rankings-title').innerHTML = `
        <span>üìä</span> ${sortLabels[sortBy] || '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥'}
        <span style="font-weight: 400; font-size: var(--text-sm); color: var(--text-tertiary); margin-left: var(--space-2);">
          ${period.start} ‚Äî ${period.end}
        </span>
      `;
      
      const tbody = document.getElementById('rankings-tbody');
      tbody.innerHTML = '';
      
      rankings.forEach((queue, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
        const rankClass = index < 3 ? `rank-${index + 1}` : '';
        
        const row = document.createElement('tr');
        row.className = 'stagger-item';
        row.style.animationDelay = `${index * 0.03}s`;
        
        // Prepare tooltip data
        const queueData = JSON.stringify({
          totalCalls: queue.totalCalls,
          answeredCalls: queue.answeredCalls,
          abandonedCalls: queue.abandonedCalls,
          answerRate: queue.answerRate,
          slaRate: queue.slaRate,
          slaCalls: queue.slaCalls || 0,
          noCallbacks: queue.noCallbacks || 0,
          noCallbacksRate: queue.noCallbacksRate || 0,
          asa: queue.asa,
          compositeScore: queue.compositeScore,
          clientCallbacks: queue.clientCallbacks || 0,
          agentCallbacks: queue.agentCallbacks || 0
        }).replace(/"/g, '&quot;');
        
        row.innerHTML = `
          <td class="rank-cell ${rankClass}">
            ${medal ? `<span class="rank-medal">${medal}</span>` : queue.rank}
          </td>
          <td>
            <div class="queue-name">${queue.queueDisplayName || queue.queueName}</div>
          </td>
          <td class="cell-center">
            <span class="badge badge-neutral">${queue.department || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
          </td>
          <td class="cell-center cell-mono info-cell" data-cell-data="${queueData}" data-cell-type="totalCalls">
            ${queue.totalCalls}
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="answerRate">
            <span class="${getStatusClass(queue.answerRate, [80, 60])}">${queue.answerRate}%</span>
            <div style="font-size: var(--text-xs); color: var(--text-tertiary);">${queue.answeredCalls}/${queue.totalCalls}</div>
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="sla">
            <span class="${getStatusClass(queue.slaRate, [80, 60])}">${queue.slaRate}%</span>
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="noCallbacksRate">
            <span class="${getStatusClass(100 - (queue.noCallbacksRate || 0), [98, 95])}">${(queue.noCallbacksRate || 0).toFixed(1)}%</span>
            <div style="font-size: var(--text-xs); color: var(--text-tertiary);">${queue.noCallbacks || 0} –∑–≤.</div>
          </td>
          <td class="cell-center cell-mono info-cell" data-cell-data="${queueData}" data-cell-type="asa">
            ${formatTime(queue.asa)}
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="compositeScore">
            <span class="rating-value">${queue.compositeScore.toFixed(1)}</span>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      document.getElementById('rankings-results').style.display = 'block';
      document.getElementById('loading-message').style.display = 'none';
      
      setupTooltips();
    }
    
    function getStatusClass(value, thresholds) {
      if (value >= thresholds[0]) return 'text-success font-bold';
      if (value >= thresholds[1]) return 'text-warning font-bold';
      return 'text-error font-bold';
    }
    
    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ, –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
      const sec = typeof seconds === 'string' ? parseInt(seconds, 10) : Number(seconds);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ä–∞–∑—É–º–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ –±–æ–ª—å—à–µ 2 —á–∞—Å–æ–≤ = 7200 —Å–µ–∫—É–Ω–¥)
      if (isNaN(sec) || sec < 0 || sec > 7200) {
        return '0:00';
      }
      
      const min = Math.floor(sec / 60);
      const remainingSec = sec % 60;
      return `${min}:${remainingSec.toString().padStart(2, '0')}`;
    }
    
    // Tooltip system
    let tooltipEl = null;
    
    function setupTooltips() {
      document.querySelectorAll('.info-cell').forEach(cell => {
        cell.addEventListener('mouseenter', showTooltip);
        cell.addEventListener('mouseleave', hideTooltip);
        cell.addEventListener('mousemove', moveTooltip);
      });
    }
    
    function showTooltip(e) {
      const cell = e.target.closest('.info-cell');
      if (!cell) return;
      
      const data = JSON.parse(cell.getAttribute('data-cell-data'));
      const type = cell.getAttribute('data-cell-type');
      
      tooltipEl = document.createElement('div');
      tooltipEl.className = 'chart-tooltip';
      tooltipEl.innerHTML = getTooltipContent(data, type);
      document.body.appendChild(tooltipEl);
      moveTooltip(e);
    }
    
    function hideTooltip() {
      if (tooltipEl) {
        tooltipEl.remove();
        tooltipEl = null;
      }
    }
    
    function moveTooltip(e) {
      if (!tooltipEl) return;
      const x = Math.min(e.clientX + 15, window.innerWidth - tooltipEl.offsetWidth - 20);
      const y = Math.min(e.clientY + 15, window.innerHeight - tooltipEl.offsetHeight - 20);
      tooltipEl.style.left = x + 'px';
      tooltipEl.style.top = y + 'px';
    }
    
    function getTooltipContent(data, type) {
      const templates = {
        totalCalls: `
          <div class="tooltip-header">üìû –í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</div>
          <div class="tooltip-row"><span class="tooltip-label">–ó–Ω–∞—á–µ–Ω–∏–µ:</span><span class="tooltip-value">${data.totalCalls}</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ò—Å—Ç–æ—á–Ω–∏–∫:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">asteriskcdrdb.queuelog</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–†–∞—Å—á—ë—Ç:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π ENTERQUEUE –∑–∞ –ø–µ—Ä–∏–æ–¥</span></div>
        `,
        answerRate: `
          <div class="tooltip-header">‚úÖ –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞</div>
          <div class="tooltip-row"><span class="tooltip-label">–§–æ—Ä–º—É–ª–∞:</span><span class="tooltip-value" style="font-family: monospace;">(–û—Ç–≤–µ—Ç–ª–µ–Ω–Ω—ã–µ / –í—Å–µ–≥–æ) √ó 100%</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–†–∞—Å—á—ë—Ç:</span><span class="tooltip-value">${data.answeredCalls} / ${data.totalCalls} √ó 100% = ${data.answerRate}%</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ì–¥–µ:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">–û—Ç–≤–µ—Ç–ª–µ–Ω–Ω—ã–µ = –∑–≤–æ–Ω–∫–∏ —Å CONNECT (–Ω–µ abandoned)</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ò—Å—Ç–æ—á–Ω–∏–∫:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">asteriskcdrdb.queuelog (event=CONNECT)</span></div>
        `,
        sla: `
          <div class="tooltip-header">‚ö° SLA (20 —Å–µ–∫—É–Ω–¥)</div>
          <div class="tooltip-row"><span class="tooltip-label">–§–æ—Ä–º—É–ª–∞:</span><span class="tooltip-value" style="font-family: monospace;">(–ó–≤–æ–Ω–∫–∏ ‚â§ 20 —Å–µ–∫ / –í—Å–µ–≥–æ) √ó 100%</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–†–∞—Å—á—ë—Ç:</span><span class="tooltip-value">${data.slaCalls || 0} / ${data.totalCalls} √ó 100% = ${data.slaRate}%</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ì–¥–µ:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">–ó–≤–æ–Ω–∫–∏ ‚â§ 20 —Å–µ–∫ = –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è ‚â§ 20 —Å–µ–∫—É–Ω–¥</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ò—Å—Ç–æ—á–Ω–∏–∫:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">queuelog (waitTime –º–µ–∂–¥—É ENTERQUEUE –∏ CONNECT)</span></div>
        `,
        noCallbacksRate: `
          <div class="tooltip-header">‚è∏Ô∏è –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
          <div class="tooltip-row"><span class="tooltip-label">–§–æ—Ä–º—É–ª–∞:</span><span class="tooltip-value" style="font-family: monospace;">–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ - –ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª —Å–∞–º - –ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª–∏ –º—ã</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–†–∞—Å—á—ë—Ç:</span><span class="tooltip-value">${data.abandonedCalls} - ${data.clientCallbacks || 0} - ${data.agentCallbacks || 0} = ${data.noCallbacks || 0}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–ü—Ä–æ—Ü–µ–Ω—Ç:</span><span class="tooltip-value">${(data.noCallbacks || 0)} / ${data.totalCalls} √ó 100% = ${(data.noCallbacksRate || 0).toFixed(1)}%</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ì–¥–µ:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ = abandoned –∏–ª–∏ duration ‚â§ 5 —Å–µ–∫</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ò—Å—Ç–æ—á–Ω–∏–∫:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">queuelog + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤ –≤ cdr</span></div>
        `,
        asa: `
          <div class="tooltip-header">‚è±Ô∏è ASA (Average Speed of Answer)</div>
          <div class="tooltip-row"><span class="tooltip-label">–§–æ—Ä–º—É–ª–∞:</span><span class="tooltip-value" style="font-family: monospace;">Œ£(–≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è) / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–†–∞—Å—á—ë—Ç:</span><span class="tooltip-value">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ = ${data.asa} —Å–µ–∫</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ì–¥–µ:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è = —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É ENTERQUEUE –∏ CONNECT</span></div>
          <div class="tooltip-row"><span class="tooltip-label" style="font-size: 0.85em; color: var(--text-tertiary);">–ò—Å—Ç–æ—á–Ω–∏–∫:</span><span class="tooltip-value" style="font-size: 0.85em; color: var(--text-tertiary);">queuelog (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤)</span></div>
        `,
        compositeScore: (function() {
          const noCallbacksRate = data.noCallbacksRate || 0;
          const callbackRate = data.abandonedCalls > 0 
            ? ((data.clientCallbacks || 0) + (data.agentCallbacks || 0)) / data.abandonedCalls * 100 
            : 100;
          const answerScore = data.answerRate * 0.40;
          const slaScore = data.slaRate * 0.25;
          const handlingScore = (100 - noCallbacksRate) * 0.15;
          const callbackScore = callbackRate * 0.10;
          const qualityScore = answerScore + slaScore + handlingScore + callbackScore;
          const volumeBonus = data.totalCalls > 0 ? Math.min(10, Math.log10(data.totalCalls) * 3.5) : 0;
          return '<div class="tooltip-header">üìä –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</div>' +
          '<div class="tooltip-row"><span class="tooltip-label">–§–æ—Ä–º—É–ª–∞:</span><span class="tooltip-value" style="font-family: monospace; font-size: 0.85em;">–ö–∞—á–µ—Å—Ç–≤–æ (90%) + –û–±—ä—ë–º (10%)</span></div>' +
          '<div class="tooltip-row" style="border-top: 1px solid var(--border-subtle); margin-top: 8px; padding-top: 8px;"><span class="tooltip-label" style="font-weight: 600;">–ö–∞—á–µ—Å—Ç–≤–æ (–¥–æ 90 –±–∞–ª–ª–æ–≤):</span></div>' +
          '<div class="tooltip-row"><span class="tooltip-label">  –û—Ç–≤–µ—Ç (40%):</span><span class="tooltip-value success">' + data.answerRate + '% √ó 0.40 = ' + answerScore.toFixed(1) + '</span></div>' +
          '<div class="tooltip-row"><span class="tooltip-label">  SLA (25%):</span><span class="tooltip-value success">' + data.slaRate + '% √ó 0.25 = ' + slaScore.toFixed(1) + '</span></div>' +
          '<div class="tooltip-row"><span class="tooltip-label">  –û–±—Ä–∞–±–æ—Ç–∫–∞ (15%):</span><span class="tooltip-value">(100 - ' + noCallbacksRate.toFixed(1) + '%) √ó 0.15 = ' + handlingScore.toFixed(1) + '<br><span style="font-size: 0.85em; color: var(--text-tertiary);">–ß–µ–º –º–µ–Ω—å—à–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö, —Ç–µ–º –≤—ã—à–µ –±–∞–ª–ª</span></span></div>' +
          '<div class="tooltip-row"><span class="tooltip-label">  –ü–µ—Ä–µ–∑–≤–æ–Ω—ã (10%):</span><span class="tooltip-value" style="color: var(--accent-success);">' + callbackRate.toFixed(1) + '% √ó 0.10 = ' + callbackScore.toFixed(1) + '</span></div>' +
          '<div class="tooltip-row" style="margin-top: 4px;"><span class="tooltip-label" style="font-weight: 600;">  –ò—Ç–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–æ:</span><span class="tooltip-value" style="font-weight: 600;">' + qualityScore.toFixed(1) + '</span></div>' +
          '<div class="tooltip-row" style="border-top: 1px solid var(--border-subtle); margin-top: 8px; padding-top: 8px;"><span class="tooltip-label" style="font-weight: 600;">–ë–æ–Ω—É—Å –∑–∞ –æ–±—ä—ë–º (–¥–æ 10 –±–∞–ª–ª–æ–≤):</span></div>' +
          '<div class="tooltip-row"><span class="tooltip-label">  –§–æ—Ä–º—É–ª–∞:</span><span class="tooltip-value" style="color: var(--accent-info); font-family: monospace;">log10(' + data.totalCalls + ') √ó 3.5 (–º–∞–∫—Å. 10)</span></div>' +
          '<div class="tooltip-row"><span class="tooltip-label">  –†–∞—Å—á—ë—Ç:</span><span class="tooltip-value" style="color: var(--accent-info);">' + Math.log10(data.totalCalls).toFixed(2) + ' √ó 3.5 = ' + volumeBonus.toFixed(1) + '</span></div>' +
          '<div class="tooltip-row" style="border-top: 2px solid var(--border-default); margin-top: 8px; padding-top: 8px;"><span class="tooltip-label" style="font-weight: 700; font-size: 1.05em;">–ò—Ç–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥:</span><span class="tooltip-value" style="font-size: 1.1em; font-weight: 700;">' + qualityScore.toFixed(1) + ' + ' + volumeBonus.toFixed(1) + ' = ' + data.compositeScore.toFixed(1) + '</span></div>';
        })()
      };
      return templates[type] || '';
    }
    
    // Export buttons
    document.getElementById('export-rankings-btn').addEventListener('click', exportToExcel);
    document.getElementById('export-excel-inline')?.addEventListener('click', exportToExcel);
    
    async function exportToExcel() {
      const form = document.getElementById('rankings-form');
      const formData = new FormData(form);
      const data = {
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        sortBy: formData.get('sortBy') || 'composite',
        departmentFilter: formData.get('departmentFilter') || null
      };
      
      try {
        const response = await fetch('/export-rankings-excel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `–†–µ–π—Ç–∏–Ω–≥_${data.start_date}_${data.end_date}.xlsx`;
          a.click();
          window.URL.revokeObjectURL(url);
        } else {
          alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      }
    }
    
    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('rankings-form').dispatchEvent(
          new Event('submit', { bubbles: true, cancelable: true })
        );
      }, 200);
    });
  </script>
</body>
</html>
