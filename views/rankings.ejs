<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css?v=<%= Date.now() %>">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="/js/status-monitor.js?v=<%= Date.now() %>"></script>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo-icon">üèÜ</div>
          <div class="logo-text">
            <h1>–†–µ–π—Ç–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π</h1>
            <div class="logo-subtitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</div>
          </div>
        </div>
        <div class="header-status-group">
          <a href="/" class="btn btn-secondary">
            <span>‚Üê</span> –ù–∞–∑–∞–¥ –∫ –æ—Ç—á–µ—Ç–∞–º
          </a>
          <div class="performance-indicator" id="system-status">
            <span id="status-indicator">‚óè</span>
            <span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>
          <div class="tech-metric" id="current-time"><%= new Date().toLocaleTimeString('ru-RU') %></div>
        </div>
      </div>
      
      <div class="header-form-container">
        <form method="POST" action="/rankings" id="rankings-form">
          <div class="form-row" style="grid-template-columns: repeat(5, 1fr);">
            <div class="form-group" style="grid-column: span 2;">
              <label for="date_range">–ü–µ—Ä–∏–æ–¥</label>
              <input type="text" id="date_range" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥" style="cursor: pointer;" readonly>
              <input type="hidden" id="start_date" name="start_date" value="<%= startDate %>">
              <input type="hidden" id="end_date" name="end_date" value="<%= endDate %>">
            </div>
            <div class="form-group">
              <label for="sortBy">–ö—Ä–∏—Ç–µ—Ä–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
              <select id="sortBy" name="sortBy">
                <option value="composite" <%= sortBy === 'composite' ? 'selected' : '' %>>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                <option value="answerRate" <%= sortBy === 'answerRate' ? 'selected' : '' %>>–ü–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –æ—Ç–≤–µ—Ç–∞</option>
                <option value="sla" <%= sortBy === 'sla' ? 'selected' : '' %>>–ü–æ SLA (20 —Å–µ–∫)</option>
                <option value="volume" <%= sortBy === 'volume' ? 'selected' : '' %>>–ü–æ –æ–±—ä–µ–º—É –∑–≤–æ–Ω–∫–æ–≤</option>
                <option value="abandonRate" <%= sortBy === 'abandonRate' ? 'selected' : '' %>>–ü–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö</option>
                <option value="asa" <%= sortBy === 'asa' ? 'selected' : '' %>>–ü–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞</option>
              </select>
            </div>
            <div class="form-group">
              <label for="departmentFilter">–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ç–¥–µ–ª—É</label>
              <select id="departmentFilter" name="departmentFilter">
                <option value="">–í—Å–µ –æ—Ç–¥–µ–ª—ã</option>
                <option value="OP" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'OP') ? 'selected' : '' %>>–û–ü</option>
                <option value="Recepcia" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'Recepcia') ? 'selected' : '' %>>–†–µ—Ü–µ–ø—Ü–∏—è</option>
                <option value="Kommun" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'Kommun') ? 'selected' : '' %>>–ö–æ–º–º—É–Ω —Ü–µ–Ω—Ç—Ä</option>
              </select>
            </div>
            <div class="form-group">
              <label style="visibility: hidden;">–î–µ–π—Å—Ç–≤–∏—è</label>
              <div style="display: flex; gap: var(--space-2);">
                <button type="button" class="btn btn-primary" id="show-rankings-btn" style="flex: 1;">
                  <span>‚ñ∂</span> –ü–æ–∫–∞–∑–∞—Ç—å
                </button>
                <button type="button" class="btn btn-secondary" id="export-rankings-btn" title="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö">
                  <span>üì•</span>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </header>

    <main>
      <!-- Loading state -->
      <div id="loading-message" class="loading-state" style="display: block;">
        <div class="spinner"></div>
        <p class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</p>
      </div>

      <!-- Error state -->
      <div id="error-message" class="card" style="display: none; border-color: var(--accent-error);">
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <h3 class="empty-state-title">–û—à–∏–±–∫–∞</h3>
          <p class="empty-state-description" id="error-text"></p>
        </div>
      </div>

      <!-- Rankings results -->
      <section id="rankings-results" style="display: none;">
        <div class="table-container">
          <div class="table-header">
            <h2 class="table-title" id="rankings-title">
              <span>üìä</span> –†–µ–π—Ç–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π
            </h2>
            <div class="table-actions export-actions">
              <button class="btn btn-secondary export-btn excel" id="export-excel-inline" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel">
                üì• Excel
              </button>
            </div>
          </div>
          <div class="table-scroll">
            <table class="rankings-table" id="rankings-table">
              <thead>
                <tr>
                  <th class="cell-center" style="width: 70px;">–†–∞–Ω–≥</th>
                  <th>–û—á–µ—Ä–µ–¥—å</th>
                  <th>–û—Ç–¥–µ–ª</th>
                  <th class="cell-center">–ó–≤–æ–Ω–∫–æ–≤ <span class="tooltip-trigger" data-tooltip="–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤">‚ÑπÔ∏è</span></th>
                  <th class="cell-center">–û—Ç–≤–µ—Ç <span class="tooltip-trigger" data-tooltip="–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤">‚ÑπÔ∏è</span></th>
                  <th class="cell-center">SLA <span class="tooltip-trigger" data-tooltip="–ó–≤–æ–Ω–∫–∏, –ø—Ä–∏–Ω—è—Ç—ã–µ –≤ –ø–µ—Ä–≤—ã–µ 20 —Å–µ–∫—É–Ω–¥">‚ÑπÔ∏è</span></th>
                  <th class="cell-center">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ <span class="tooltip-trigger" data-tooltip="–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –±–µ–∑ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞">‚ÑπÔ∏è</span></th>
                  <th class="cell-center">ASA <span class="tooltip-trigger" data-tooltip="–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞">‚ÑπÔ∏è</span></th>
                  <th class="cell-center">–†–µ–π—Ç–∏–Ω–≥ <span class="tooltip-trigger" data-tooltip="–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ 0-100">‚ÑπÔ∏è</span></th>
                </tr>
              </thead>
              <tbody id="rankings-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Show Rankings button
    document.getElementById('show-rankings-btn').addEventListener('click', () => {
      document.getElementById('rankings-form').dispatchEvent(
        new Event('submit', { bubbles: true, cancelable: true })
      );
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flatpickr –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
    const dateRangeInput = document.getElementById('date_range');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    let flatpickrInstance = null;
    if (dateRangeInput) {
      const startDate = startDateInput ? startDateInput.value : '';
      const endDate = endDateInput ? endDateInput.value : '';
      
      flatpickrInstance = flatpickr(dateRangeInput, {
        mode: "range",
        dateFormat: "d.m.Y",
        locale: {
          firstDayOfWeek: 1,
          weekdays: { shorthand: ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"], longhand: ["–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"] },
          months: { shorthand: ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"], longhand: ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"] }
        },
        defaultDate: startDate && endDate ? [startDate, endDate] : null,
        onChange: function(selectedDates, dateStr, instance) {
          if (selectedDates.length === 2) {
            const start = selectedDates[0];
            const end = selectedDates[1];
            const startFormatted = start.getFullYear() + '-' + 
              String(start.getMonth() + 1).padStart(2, '0') + '-' + 
              String(start.getDate()).padStart(2, '0');
            const endFormatted = end.getFullYear() + '-' + 
              String(end.getMonth() + 1).padStart(2, '0') + '-' + 
              String(end.getDate()).padStart(2, '0');
            
            if (startDateInput) startDateInput.value = startFormatted;
            if (endDateInput) endDateInput.value = endFormatted;
          } else if (selectedDates.length === 0) {
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
          }
        }
      });
    }
    
    // Form submit handler
    document.getElementById('rankings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        sortBy: formData.get('sortBy') || 'composite',
        departmentFilter: formData.get('departmentFilter') || null
      };
      
      // Show loading
      document.getElementById('loading-message').style.display = 'flex';
      document.getElementById('rankings-results').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
      
      try {
        const response = await fetch('/rankings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success && result.rankings?.length > 0) {
          displayRankings(result.rankings, result.sortBy, result.period);
        } else {
          throw new Error(result.error || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥');
        }
      } catch (error) {
        document.getElementById('error-text').textContent = error.message;
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('loading-message').style.display = 'none';
      }
    });

    function displayRankings(rankings, sortBy, period) {
      const sortLabels = {
        composite: '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥',
        answerRate: '–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞',
        sla: 'SLA (20 —Å–µ–∫)',
        volume: '–û–±—ä–µ–º –∑–≤–æ–Ω–∫–æ–≤',
        abandonRate: '–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ',
        asa: '–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞'
      };
      
      document.getElementById('rankings-title').innerHTML = `
        <span>üìä</span> ${sortLabels[sortBy] || '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥'}
        <span style="font-weight: 400; font-size: var(--text-sm); color: var(--text-tertiary); margin-left: var(--space-2);">
          ${period.start} ‚Äî ${period.end}
        </span>
      `;
      
      const tbody = document.getElementById('rankings-tbody');
      tbody.innerHTML = '';
      
      rankings.forEach((queue, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
        const rankClass = index < 3 ? `rank-${index + 1}` : '';
        
        const row = document.createElement('tr');
        row.className = 'stagger-item';
        row.style.animationDelay = `${index * 0.03}s`;
        
        // Prepare tooltip data
        const queueData = JSON.stringify({
          totalCalls: queue.totalCalls,
          answeredCalls: queue.answeredCalls,
          abandonedCalls: queue.abandonedCalls,
          answerRate: queue.answerRate,
          slaRate: queue.slaRate,
          slaCalls: queue.slaCalls || 0,
          noCallbacks: queue.noCallbacks || 0,
          noCallbacksRate: queue.noCallbacksRate || 0,
          asa: queue.asa,
          compositeScore: queue.compositeScore,
          clientCallbacks: queue.clientCallbacks || 0,
          agentCallbacks: queue.agentCallbacks || 0
        }).replace(/"/g, '&quot;');
        
        row.innerHTML = `
          <td class="rank-cell ${rankClass}">
            ${medal ? `<span class="rank-medal">${medal}</span>` : queue.rank}
          </td>
          <td>
            <div class="queue-name">${queue.queueDisplayName || queue.queueName}</div>
          </td>
          <td class="cell-center">
            <span class="badge badge-neutral">${queue.department || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
          </td>
          <td class="cell-center cell-mono info-cell" data-cell-data="${queueData}" data-cell-type="totalCalls">
            ${queue.totalCalls}
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="answerRate">
            <span class="${getStatusClass(queue.answerRate, [80, 60])}">${queue.answerRate}%</span>
            <div style="font-size: var(--text-xs); color: var(--text-tertiary);">${queue.answeredCalls}/${queue.totalCalls}</div>
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="sla">
            <span class="${getStatusClass(queue.slaRate, [80, 60])}">${queue.slaRate}%</span>
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="noCallbacksRate">
            <span class="${getStatusClass(100 - (queue.noCallbacksRate || 0), [98, 95])}">${(queue.noCallbacksRate || 0).toFixed(1)}%</span>
            <div style="font-size: var(--text-xs); color: var(--text-tertiary);">${queue.noCallbacks || 0} –∑–≤.</div>
          </td>
          <td class="cell-center cell-mono info-cell" data-cell-data="${queueData}" data-cell-type="asa">
            ${formatTime(queue.asa)}
          </td>
          <td class="cell-center info-cell" data-cell-data="${queueData}" data-cell-type="compositeScore">
            <span class="rating-value">${queue.compositeScore.toFixed(1)}</span>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      document.getElementById('rankings-results').style.display = 'block';
      document.getElementById('loading-message').style.display = 'none';
      
      setupTooltips();
    }
    
    function getStatusClass(value, thresholds) {
      if (value >= thresholds[0]) return 'text-success font-bold';
      if (value >= thresholds[1]) return 'text-warning font-bold';
      return 'text-error font-bold';
    }
    
    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ, –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
      const sec = typeof seconds === 'string' ? parseInt(seconds, 10) : Number(seconds);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ä–∞–∑—É–º–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ –±–æ–ª—å—à–µ 2 —á–∞—Å–æ–≤ = 7200 —Å–µ–∫—É–Ω–¥)
      if (isNaN(sec) || sec < 0 || sec > 7200) {
        return '0:00';
      }
      
      const min = Math.floor(sec / 60);
      const remainingSec = sec % 60;
      return `${min}:${remainingSec.toString().padStart(2, '0')}`;
    }
    
    // Tooltip system
    let tooltipEl = null;
    
    function setupTooltips() {
      document.querySelectorAll('.info-cell').forEach(cell => {
        cell.addEventListener('mouseenter', showTooltip);
        cell.addEventListener('mouseleave', hideTooltip);
        cell.addEventListener('mousemove', moveTooltip);
      });
    }
    
    function showTooltip(e) {
      const cell = e.target.closest('.info-cell');
      if (!cell) return;
      
      const data = JSON.parse(cell.getAttribute('data-cell-data'));
      const type = cell.getAttribute('data-cell-type');
      
      tooltipEl = document.createElement('div');
      tooltipEl.className = 'chart-tooltip';
      tooltipEl.innerHTML = getTooltipContent(data, type);
      document.body.appendChild(tooltipEl);
      moveTooltip(e);
    }
    
    function hideTooltip() {
      if (tooltipEl) {
        tooltipEl.remove();
        tooltipEl = null;
      }
    }
    
    function moveTooltip(e) {
      if (!tooltipEl) return;
      const x = Math.min(e.clientX + 15, window.innerWidth - tooltipEl.offsetWidth - 20);
      const y = Math.min(e.clientY + 15, window.innerHeight - tooltipEl.offsetHeight - 20);
      tooltipEl.style.left = x + 'px';
      tooltipEl.style.top = y + 'px';
    }
    
    function getTooltipContent(data, type) {
      const templates = {
        totalCalls: `
          <div class="tooltip-header">üìû –í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</div>
          <div class="tooltip-row"><span class="tooltip-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span><span class="tooltip-value">${data.totalCalls}</span></div>
        `,
        answerRate: `
          <div class="tooltip-header">‚úÖ –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞</div>
          <div class="tooltip-row"><span class="tooltip-label">–§–æ—Ä–º—É–ª–∞:</span><span class="tooltip-value">(–û—Ç–≤–µ—Ç / –í—Å–µ–≥–æ) √ó 100%</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–†–∞—Å—á—ë—Ç:</span><span class="tooltip-value">${data.answeredCalls} / ${data.totalCalls} = ${data.answerRate}%</span></div>
        `,
        sla: `
          <div class="tooltip-header">‚ö° SLA (20 —Å–µ–∫—É–Ω–¥)</div>
          <div class="tooltip-row"><span class="tooltip-label">–ó–≤–æ–Ω–∫–∏ SLA:</span><span class="tooltip-value">${data.slaCalls}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–ü—Ä–æ—Ü–µ–Ω—Ç:</span><span class="tooltip-value">${data.slaRate}%</span></div>
        `,
        noCallbacksRate: `
          <div class="tooltip-header">‚è∏Ô∏è –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
          <div class="tooltip-row"><span class="tooltip-label">–ë–µ–∑ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞:</span><span class="tooltip-value">${data.noCallbacks}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ:</span><span class="tooltip-value">${data.abandonedCalls}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–ü—Ä–æ—Ü–µ–Ω—Ç:</span><span class="tooltip-value">${(data.noCallbacksRate || 0).toFixed(1)}%</span></div>
        `,
        asa: `
          <div class="tooltip-header">‚è±Ô∏è ASA (Average Speed of Answer)</div>
          <div class="tooltip-row"><span class="tooltip-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è:</span><span class="tooltip-value">${formatTime(data.asa)}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–í —Å–µ–∫—É–Ω–¥–∞—Ö:</span><span class="tooltip-value">${data.asa} —Å–µ–∫</span></div>
        `,
        compositeScore: `
          <div class="tooltip-header">üìä –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</div>
          <div class="tooltip-row"><span class="tooltip-label">–û—Ç–≤–µ—Ç (30%):</span><span class="tooltip-value success">+${(data.answerRate * 0.30).toFixed(1)}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">SLA (25%):</span><span class="tooltip-value success">+${(data.slaRate * 0.25).toFixed(1)}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–û–±—ä—ë–º (15%):</span><span class="tooltip-value success">+${(Math.min(data.totalCalls / 1000, 1) * 100 * 0.15).toFixed(1)}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">–ò—Ç–æ–≥–æ:</span><span class="tooltip-value" style="font-size: 1.1em; font-weight: 700;">${data.compositeScore.toFixed(1)}</span></div>
        `
      };
      return templates[type] || '';
    }
    
    // Export buttons
    document.getElementById('export-rankings-btn').addEventListener('click', exportToExcel);
    document.getElementById('export-excel-inline')?.addEventListener('click', exportToExcel);
    
    async function exportToExcel() {
      const form = document.getElementById('rankings-form');
      const formData = new FormData(form);
      const data = {
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        sortBy: formData.get('sortBy') || 'composite',
        departmentFilter: formData.get('departmentFilter') || null
      };
      
      try {
        const response = await fetch('/export-rankings-excel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `–†–µ–π—Ç–∏–Ω–≥_${data.start_date}_${data.end_date}.xlsx`;
          a.click();
          window.URL.revokeObjectURL(url);
        } else {
          alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      }
    }
    
    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('rankings-form').dispatchEvent(
          new Event('submit', { bubbles: true, cancelable: true })
        );
      }, 200);
    });
  </script>
</body>
</html>
