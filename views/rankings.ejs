<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css?v=<%= Date.now() %>">
</head>
<body>
  <div class="app-container">
  <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo-icon">üèÜ</div>
          <div class="logo-text">
            <h1>–†–µ–π—Ç–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π</h1>
            <div class="logo-subtitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</div>
          </div>
        </div>
        <div class="header-status-group">
          <a href="/" class="view-selector-btn" style="text-decoration: none; display: inline-flex; margin-right: 10px;">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –æ—Ç—á–µ—Ç–∞–º
          </a>
        </div>
      </div>
    </header>

    <main class="main-content">
      <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <section class="stats-header-section">
        <form method="POST" action="/rankings" id="rankings-form">
        <div class="header-form-grid">
          <div class="form-field">
            <label for="start_date" class="form-label">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</label>
            <input type="date" id="start_date" name="start_date" value="<%= startDate %>" required>
            </div>
          <div class="form-field">
            <label for="end_date" class="form-label">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</label>
            <input type="date" id="end_date" name="end_date" value="<%= endDate %>" required>
            </div>
            <div class="form-field">
              <label for="sortBy" class="form-label">–ö—Ä–∏—Ç–µ—Ä–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
              <select id="sortBy" name="sortBy">
                <option value="composite" <%= sortBy === 'composite' ? 'selected' : '' %>>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                <option value="answerRate" <%= sortBy === 'answerRate' ? 'selected' : '' %>>–ü–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –æ—Ç–≤–µ—Ç–∞</option>
                <option value="sla" <%= sortBy === 'sla' ? 'selected' : '' %>>–ü–æ SLA (20 —Å–µ–∫)</option>
                <option value="volume" <%= sortBy === 'volume' ? 'selected' : '' %>>–ü–æ –æ–±—ä–µ–º—É –∑–≤–æ–Ω–∫–æ–≤</option>
                <option value="abandonRate" <%= sortBy === 'abandonRate' ? 'selected' : '' %>>–ü–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö</option>
                <option value="asa" <%= sortBy === 'asa' ? 'selected' : '' %>>–ü–æ —Å—Ä–µ–¥–Ω–µ–º—É –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞</option>
              </select>
            </div>
            <div class="form-field">
              <label for="departmentFilter" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ç–¥–µ–ª—É</label>
              <select id="departmentFilter" name="departmentFilter">
                <option value="">–í—Å–µ –æ—Ç–¥–µ–ª—ã</option>
                <option value="OP" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'OP') ? 'selected' : '' %>>–û–ü</option>
                <option value="Recepcia" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'Recepcia') ? 'selected' : '' %>>–†–µ—Ü–µ–ø—Ü–∏—è</option>
                <option value="Kommun" <%= (typeof departmentFilter !== 'undefined' && departmentFilter === 'Kommun') ? 'selected' : '' %>>–ö–æ–º–º—É–Ω —Ü–µ–Ω—Ç—Ä</option>
              </select>
            </div>
            <div class="form-field">
              <button type="submit" class="btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥</button>
            </div>
          </div>
        </form>
      </section>

      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
      <section id="rankings-results" style="display: none;">
          <div class="stats-dashboard">
          <h2 id="rankings-title"></h2>
          <div id="rankings-table-container"></div>
          </div>
        </section>

      <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ -->
      <section id="loading-message" style="text-align: center; padding: 40px; display: block;">
        <div style="font-size: 18px; color: #666;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
            </section>

      <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
      <section id="error-message" style="text-align: center; padding: 40px; display: none;">
        <div style="font-size: 18px; color: #d32f2f;">‚ùå <span id="error-text"></span></div>
            </section>
  </main>
    </div>

  <script>
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('rankings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        sortBy: formData.get('sortBy') || 'composite',
        departmentFilter: formData.get('departmentFilter') || null
      };
      
      console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', data);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      document.getElementById('loading-message').style.display = 'block';
      document.getElementById('rankings-results').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
      
      try {
        const response = await fetch('/rankings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç API:', result);
        
        if (result.success) {
          if (result.rankings && result.rankings.length > 0) {
            displayRankings(result.rankings, result.sortBy, result.period, result);
          } else {
            console.warn('–ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤:', result);
            document.getElementById('error-text').textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥.';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('loading-message').style.display = 'none';
          }
        } else {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–π—Ç–∏–Ω–≥–∞');
        }
      } catch (error) {
        document.getElementById('error-text').textContent = error.message;
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('loading-message').style.display = 'none';
      }
    });

    function displayRankings(rankings, sortBy, period) {
      const container = document.getElementById('rankings-table-container');
      const title = document.getElementById('rankings-title');
      
      const sortLabels = {
        composite: '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥',
        answerRate: '–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞',
        sla: 'SLA (20 —Å–µ–∫)',
        volume: '–û–±—ä–µ–º –∑–≤–æ–Ω–∫–æ–≤',
        abandonRate: '–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö',
        asa: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞'
      };
      
      title.textContent = `–†–µ–π—Ç–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—é: ${sortLabels[sortBy] || '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥'} (${period.start} - ${period.end})`;
      
      let html = `
        <table class="data-table" style="width: 100%; margin-top: 20px;">
          <thead>
            <tr>
              <th style="width: 60px;">–†–∞–Ω–≥</th>
              <th>–û—á–µ—Ä–µ–¥—å</th>
            <th>–û—Ç–¥–µ–ª</th>
              <th>–ó–≤–æ–Ω–∫–æ–≤</th>
              <th>–û—Ç–≤–µ—Ç</th>
              <th>SLA</th>
              <th>–ü—Ä–æ–ø—É—â–µ–Ω–æ</th>
              <th>ASA</th>
              <th>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      rankings.forEach((queue, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
        const rankClass = index < 3 ? 'top-rank' : '';
        
        html += `
          <tr class="${rankClass}">
            <td style="text-align: center; font-weight: bold;">
              ${medal} ${queue.rank}
            </td>
            <td><strong>${queue.queueDisplayName || queue.queueName}</strong></td>
            <td style="text-align: center;">${queue.department || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
            <td style="text-align: center;">${queue.totalCalls}</td>
            <td style="text-align: center;">
              <span style="color: ${queue.answerRate >= 80 ? '#4caf50' : queue.answerRate >= 60 ? '#ff9800' : '#f44336'};">
                ${queue.answerRate}%
              </span>
              <small style="display: block; color: #666;">${queue.answeredCalls} –∏–∑ ${queue.totalCalls}</small>
            </td>
            <td style="text-align: center;">
              <span style="color: ${queue.slaRate >= 80 ? '#4caf50' : queue.slaRate >= 60 ? '#ff9800' : '#f44336'};">
                ${queue.slaRate}%
              </span>
            </td>
            <td style="text-align: center;">
              <span style="color: ${queue.abandonRate <= 10 ? '#4caf50' : queue.abandonRate <= 20 ? '#ff9800' : '#f44336'};">
                ${queue.abandonRate}%
              </span>
              <small style="display: block; color: #666;">${queue.abandonedCalls} –∑–≤–æ–Ω–∫–æ–≤</small>
            </td>
            <td style="text-align: center;">${formatTime(queue.asa)}</td>
            <td style="text-align: center;">
              <strong style="font-size: 18px; color: ${queue.compositeScore >= 80 ? '#4caf50' : queue.compositeScore >= 60 ? '#ff9800' : '#f44336'};">
                ${queue.compositeScore.toFixed(1)}
              </strong>
            </td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
      document.getElementById('rankings-results').style.display = 'block';
      document.getElementById('loading-message').style.display = 'none';
    }

    function formatTime(seconds) {
      if (!seconds) return '0:00';
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', () => {
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ —Ñ–æ—Ä–º—ã
      const form = document.getElementById('rankings-form');
      if (form) {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(() => {
          const formEvent = new Event('submit', { bubbles: true, cancelable: true });
          form.dispatchEvent(formEvent);
        }, 200);
      }
    });
  </script>

  <style>
    .top-rank {
      background-color: #fff9c4;
    }
    .top-rank:hover {
      background-color: #fff59d;
    }
    .data-table th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #ddd;
    }
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    .data-table tr:hover {
      background-color: #f9f9f9;
    }
  </style>
</body>
</html>
