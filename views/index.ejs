<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Asterisk Queue Analytics - Technical Monitoring Dashboard for Asterisk PBX systems">
  <meta name="keywords" content="Asterisk, PBX, queue analytics, technical monitoring, call center metrics">
  <meta name="author" content="Asterisk Analytics Team">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Asterisk Queue Analytics">
  <meta property="og:description" content="Technical monitoring dashboard for Asterisk PBX queue performance analysis">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/images/asterisk-analytics.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Asterisk Queue Analytics">
  <meta name="twitter:description" content="Technical monitoring dashboard for Asterisk PBX systems">
  <link rel="canonical" href="<%= typeof url !== 'undefined' ? url : 'http://localhost:3000' %>">
  <title>Asterisk Queue Analytics - Technical Dashboard</title>

  <!-- Material Design 3 Tech Specialist Interface -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css?v=<%= Date.now() %>">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "Asterisk Queue Analytics",
    "description": "Technical monitoring dashboard for Asterisk PBX queue performance analysis",
    "url": "<%= typeof url !== 'undefined' ? url : 'http://localhost:3000' %>",
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "author": {
      "@type": "Organization",
      "name": "Asterisk Analytics Team"
    }
  }
  </script>
</head>
<body>
  <div class="app-container">
  <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo-icon">‚ö°</div>
          <div class="logo-text">
            <h1>Asterisk Queue Analytics</h1>
            <div class="logo-subtitle">
              Technical Monitoring Dashboard
            </div>
          </div>
        </div>
        <div class="header-status-group">
          <div class="performance-indicator" id="system-status">
            <span id="status-indicator">‚óè</span> <span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>
          <div class="tech-metric" id="current-time"><%= new Date().toLocaleTimeString('ru-RU') %></div>
        </div>
    </div>
    
    <!-- Query Form Section - Above Navigation Tabs -->
    <div class="header-form-container">
      <form method="POST" action="/report" role="form" aria-labelledby="query-form-title">
        <input type="hidden" name="view_type" value="<%= typeof viewType !== 'undefined' ? viewType : 'queue' %>" id="view_type">
        
        <!-- Quick Date Filters -->
        <div class="quick-filters">
          <button type="button" class="quick-filter-btn" data-period="today">–°–µ–≥–æ–¥–Ω—è</button>
          <button type="button" class="quick-filter-btn" data-period="yesterday">–í—á–µ—Ä–∞</button>
          <button type="button" class="quick-filter-btn" data-period="week">–ù–µ–¥–µ–ª—è</button>
          <button type="button" class="quick-filter-btn" data-period="month">–ú–µ—Å—è—Ü</button>
      </div>
        
        <div class="header-form-grid">
          <div class="form-field">
              <label for="queue_name" class="form-label">–û—á–µ—Ä–µ–¥—å</label>
            <select id="queue_name" name="queue_name" <%= typeof viewType === 'undefined' || viewType === 'queue' ? 'required' : '' %> <%= typeof viewType !== 'undefined' && (viewType === 'inbound' || viewType === 'outbound') ? 'disabled' : '' %>>
              <% if (queues && queues.length > 0) { %>
                <% queues.forEach(queue => { %>
                  <option value="<%= queue %>" <%= queue === selectedQueue ? 'selected' : '' %>><%= queue %></option>
                <% }); %>
              <% } else { %>
                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
              <% } %>
              </select>
            </div>
            
          <div class="form-field">
            <label for="start_date" class="form-label">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</label>
            <input type="date" id="start_date" name="start_date" value="<%= startDate %>" required>
            </div>
            
          <div class="form-field">
            <label for="end_date" class="form-label">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</label>
            <input type="date" id="end_date" name="end_date" value="<%= endDate %>" required>
            </div>
            
          <div class="form-field form-field-actions">
            <button type="submit" class="submit-btn">
              <span class="btn-icon">‚ñ∂</span>
              <span>–í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑</span>
              </button>
            </div>
          </div>
        </form>
    </div>
    
    <!-- Navigation Tabs -->
    <nav class="nav-tabs" role="navigation" aria-label="Main navigation">
      <a href="/" class="nav-tab <%= typeof viewType === 'undefined' || viewType === 'queue' ? 'active' : '' %>" data-view="queue">
        <span class="nav-tab-icon">üìû</span>
        <span class="nav-tab-text">–ü–æ –æ—á–µ—Ä–µ–¥—è–º</span>
      </a>
      <a href="/inbound" class="nav-tab <%= viewType === 'inbound' ? 'active' : '' %>" data-view="inbound">
        <span class="nav-tab-icon">üì•</span>
        <span class="nav-tab-text">–í—Ö–æ–¥—è—â–∏–µ</span>
      </a>
      <a href="/outbound" class="nav-tab <%= viewType === 'outbound' ? 'active' : '' %>" data-view="outbound">
        <span class="nav-tab-icon">üì§</span>
        <span class="nav-tab-text">–ò—Å—Ö–æ–¥—è—â–∏–µ</span>
      </a>
    </nav>
  </header>

    <main class="main-content">

        <% if (!results) { %>
          <div class="alert alert-info">
          <span>‚ÑπÔ∏è</span>
          –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫
          </div>
        <% } else if (results.error) { %>
        <div class="alert alert-error">
          <span>‚ö†Ô∏è</span>
            <%= results.error %>
          </div>
        <% } else { %>
        <!-- Call Center Statistics Header -->
        <section class="stats-header-section">
          <div class="section-header">
            <div class="section-actions">
              <button type="button" class="export-btn" id="export-btn" title="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö">
                <span class="btn-icon">üì•</span>
                <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
              </button>
            </div>
          </div>
          
          <div class="stats-grid">
            <!-- –í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤ -->
            <div class="stat-item stat-item-primary">
              <div class="stat-icon">üìû</div>
              <div class="stat-content">
                <div class="stat-label">–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</div>
                <div class="stat-value-large"><%= results.stats.totalCalls %></div>
                <div class="stat-description">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
              </div>
            </div>

            <!-- –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞ -->
            <div class="stat-item stat-item-success" data-percent="<%= results.stats.answerRate %>">
              <div class="stat-icon">‚úÖ</div>
              <div class="stat-content">
                <div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞</div>
                <div class="stat-value-large"><%= results.stats.answerRate %>%</div>
                <div class="stat-description"><%= results.stats.answeredCalls %> –∏–∑ <%= results.stats.totalCalls %> –ø—Ä–∏–Ω—è—Ç–æ</div>
                <div class="stat-progress">
                  <div class="progress-bar" style="width: <%= results.stats.answerRate %>%"></div>
                </div>
              </div>
            </div>

            <!-- SLA -->
            <div class="stat-item stat-item-warning" data-percent="<%= results.stats.slaRate %>">
              <div class="stat-icon">‚è±Ô∏è</div>
              <div class="stat-content">
                <div class="stat-label">SLA (20 —Å–µ–∫)</div>
                <div class="stat-value-large"><%= results.stats.slaRate %>%</div>
                <div class="stat-description">–ü—Ä–∏–Ω—è—Ç–æ –≤ –ø–µ—Ä–≤—ã–µ 20 —Å–µ–∫</div>
                <div class="stat-progress">
                  <div class="progress-bar" style="width: <%= results.stats.slaRate %>%"></div>
                </div>
              </div>
            </div>

            <!-- –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∏ -->
            <div class="stat-item stat-item-danger" data-percent="<%= results.stats.totalCalls > 0 ? Math.round(results.stats.abandonedCalls / results.stats.totalCalls * 100) : 0 %>">
              <div class="stat-icon">‚ùå</div>
              <div class="stat-content">
                <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∏</div>
                <div class="stat-value-large"><%= results.stats.abandonedCalls %></div>
                <div class="stat-description"><%= results.stats.totalCalls > 0 ? Math.round(results.stats.abandonedCalls / results.stats.totalCalls * 100) : 0 %>% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞</div>
                <div class="stat-progress">
                  <div class="progress-bar" style="width: <%= results.stats.totalCalls > 0 ? Math.round(results.stats.abandonedCalls / results.stats.totalCalls * 100) : 0 %>%"></div>
                </div>
              </div>
            </div>

            <!-- –ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª —Å–∞–º -->
            <div class="stat-item">
              <div class="stat-icon">‚Ü©Ô∏è</div>
              <div class="stat-content">
                <div class="stat-label">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª —Å–∞–º</div>
                <div class="stat-value-large"><%= results.stats.clientCallbacks || 0 %></div>
                <div class="stat-description">–ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–ª</div>
              </div>
            </div>

            <!-- –ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª–∏ –º—ã -->
            <div class="stat-item">
              <div class="stat-icon">üìû</div>
              <div class="stat-content">
                <div class="stat-label">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª–∏ –º—ã</div>
                <div class="stat-value-large"><%= results.stats.agentCallbacks || 0 %></div>
                <div class="stat-description">–ê–≥–µ–Ω—Ç –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–ª</div>
              </div>
            </div>

            <!-- –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω -->
            <div class="stat-item">
              <div class="stat-icon">‚è∏Ô∏è</div>
              <div class="stat-content">
                <div class="stat-label">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</div>
                <% 
                  // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é: –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –º–∏–Ω—É—Å –ø–µ—Ä–µ–∑–≤–æ–Ω—ã
                  const clientCb = results.stats.clientCallbacks || 0;
                  const agentCb = results.stats.agentCallbacks || 0;
                  const notProcessed = results.stats.abandonedCalls - clientCb - agentCb;
                %>
                <div class="stat-value-large"><%= notProcessed >= 0 ? notProcessed : 0 %></div>
                <div class="stat-description">–ë–µ–∑ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞</div>
              </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω–µ–µ –æ–∂–∏–¥–∞–Ω–∏–µ -->
            <div class="stat-item">
              <div class="stat-icon">‚è≥</div>
              <div class="stat-content">
                <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –æ–∂–∏–¥–∞–Ω–∏–µ</div>
                <div class="stat-value-large">
                  <% 
                    const avgWaitTime = results.stats.avgWaitTimeAnswered || results.stats.avgWaitTime || 0;
                    const avgWaitMin = Math.floor(avgWaitTime / 60);
                    const avgWaitSec = Math.round(avgWaitTime % 60);
                    const avgWaitSecStr = avgWaitSec < 10 ? '0' + avgWaitSec : avgWaitSec;
                    const displayValue = isNaN(avgWaitMin) || isNaN(avgWaitSec) ? '0:00' : `${avgWaitMin}:${avgWaitSecStr}`;
                  %>
                  <%= displayValue %>
                </div>
                <div class="stat-description">–î–ª—è –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤</div>
              </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ -->
            <div class="stat-item">
              <div class="stat-icon">üí¨</div>
              <div class="stat-content">
                <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞</div>
                <div class="stat-value-large">
                  <% 
                    const avgDurMin = Math.floor(results.stats.avgDuration / 60);
                    const avgDurSec = results.stats.avgDuration % 60;
                    const avgDurSecStr = avgDurSec < 10 ? '0' + avgDurSec : avgDurSec;
                  %>
                  <%= avgDurMin %>:<%= avgDurSecStr %>
              </div>
                <div class="stat-description">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–≤–æ–Ω–∫–æ–≤</div>
              </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤ –æ—á–µ—Ä–µ–¥–∏ -->
            <div class="stat-item">
              <div class="stat-icon">üìä</div>
              <div class="stat-content">
                <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤ –æ—á–µ—Ä–µ–¥–∏</div>
                <div class="stat-value-large"><%= results.stats.avgQueueTime %></div>
                <div class="stat-description">—Å–µ–∫. –î–ª—è –≤—Å–µ—Ö –∑–≤–æ–Ω–∫–æ–≤</div>
              </div>
              </div>

            <!-- –ü–∏–∫–æ–≤—ã–π —á–∞—Å -->
            <div class="stat-item">
              <div class="stat-icon">üìà</div>
              <div class="stat-content">
                <div class="stat-label">–ü–∏–∫–æ–≤—ã–π —á–∞—Å</div>
                <div class="stat-value-large"><%= results.stats.peakHour %></div>
                <div class="stat-description">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞</div>
              </div>
            </div>

            <!-- ASA (Average Speed of Answer) -->
            <% if (typeof viewType === 'undefined' || viewType === 'queue') { %>
            <div class="stat-item stat-item-info">
              <div class="stat-icon">‚ö°</div>
              <div class="stat-content">
                <div class="stat-label">ASA</div>
                <div class="stat-value-large">
                  <% 
                    const asa = results.stats.asa || 0;
                    const asaMin = Math.floor(asa / 60);
                    const asaSec = asa % 60;
                    const asaSecStr = asaSec < 10 ? '0' + asaSec : asaSec;
                  %>
                  <%= asaMin %>:<%= asaSecStr %>
                </div>
                <div class="stat-description">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                <div class="stat-progress">
                  <div class="progress-bar progress-bar-info" style="width: <%= Math.min(100, (asa / 60) * 10) %>%"></div>
                </div>
              </div>
            </div>

            <!-- Abandon Rate -->
            <div class="stat-item stat-item-danger" data-percent="<%= results.stats.abandonRate || 0 %>">
              <div class="stat-icon">üìâ</div>
              <div class="stat-content">
                <div class="stat-label">Abandon Rate</div>
                <div class="stat-value-large"><%= results.stats.abandonRate || 0 %>%</div>
                <div class="stat-description">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö</div>
                <div class="stat-progress">
                  <div class="progress-bar" style="width: <%= results.stats.abandonRate || 0 %>%"></div>
                </div>
              </div>
            </div>
            <% } %>
          </div>
        </section>

        <!-- Technical Dashboard Layout -->
        <div class="main-dashboard">
            <!-- Performance Chart -->
            <section class="chart-section">
              <div class="hourly-chart-container">
                <div class="hourly-chart-svg" id="hourly-chart">
                  <!-- SVG –≥—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω JavaScript -->
                </div>
                <div class="chart-tooltip" id="chart-tooltip" style="display: none;">
                  <div class="tooltip-time" id="tooltip-time"></div>
                  <div class="tooltip-stats">
                    <div class="tooltip-stat">
                      <span class="tooltip-label">–í—Å–µ–≥–æ:</span>
                      <span class="tooltip-value" id="tooltip-total">0</span>
                    </div>
                    <div class="tooltip-stat">
                      <span class="tooltip-label answered">–û—Ç–≤–µ—á–µ–Ω–Ω—ã–µ:</span>
                      <span class="tooltip-value" id="tooltip-answered">0</span>
      </div>
                    <div class="tooltip-stat">
                      <span class="tooltip-label abandoned">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω:</span>
                      <span class="tooltip-value" id="tooltip-abandoned">0</span>
      </div>
    </div>
  </div>
  </div>
            </section>

            <!-- Detailed Data Table -->
            <section class="table-section">
              <div class="table-header">
                <h3 class="table-title">–î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –∑–≤–æ–Ω–∫–æ–≤</h3>
                <div class="table-controls">
                  <div class="items-per-page">
                    <label style="font-size: 0.875rem; margin-right: var(--md-spacing-xs);">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å:</label>
                    <select id="items-per-page">
                      <option value="10">10</option>
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
    </div>
                  <div class="table-search">
                    <input type="text" id="table-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, —Å—Ç–∞—Ç—É—Å—É...">
    </div>
  </div>
</div>

              <div class="table-container">
                <table class="data-table" role="table" aria-label="Technical call log">
                    <thead>
                      <tr>
                      <th scope="col" data-sort="date" class="sortable">
                        –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="client" class="sortable">
                        –ù–æ–º–µ—Ä –∞–±–æ–Ω–µ–Ω—Ç–∞ <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="wait" class="sortable">
                        –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="duration" class="sortable">
                        –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="status" class="sortable">
                        –°—Ç–∞—Ç—É—Å <span class="sort-icon"></span>
                      </th>
                      <th scope="col">–ó–∞–ø–∏—Å—å</th>
                      </tr>
                    </thead>
                  <tbody id="calls-tbody">
                      <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π -->
                    </tbody>
                  </table>
                </div>

              <div class="pagination-section">
                <div class="pagination-info" id="pagination-info">
                  –ü–æ–∫–∞–∑–∞–Ω–æ 1-<%= Math.min(results.calls.length, 25) %> –∏–∑ <%= results.stats.totalCalls %> –∑–∞–ø–∏—Å–µ–π
                </div>
                <div class="pagination-controls" id="pagination-controls">
                  <!-- Pagination buttons will be generated by JavaScript -->
                </div>
              </div>
            </section>
            </div>
          </div>
        <% } %>

      <!-- Toast Notifications Container -->
      <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container" style="z-index: 9999;">
      </div>

      <!-- Hidden data for JavaScript -->
      <% if (results && results.calls && results.calls.length > 0) { %>
        <div id="chart-data" data-chart='<%- JSON.stringify(results).replace(/'/g, '&#39;') %>' style="display: none;"></div>
        <div id="calls-data" data-calls='<%- JSON.stringify(results.calls).replace(/'/g, '&#39;') %>' style="display: none;"></div>
        <div id="hourly-data" data-hourly='<%- JSON.stringify(results.stats.callsByHour).replace(/'/g, '&#39;') %>' style="display: none;"></div>
      <% } %>
    </main>
    </div>

  <!-- Scripts -->
  <!-- Status Monitor - Independent module -->
  <script src="/js/status-monitor.js?v=<%= Date.now() %>"></script>
  
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/js/chart.js?v=<%= Date.now() %>"></script>
  
  <!-- Navigation Script -->
  <script>
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
      const navTabs = document.querySelectorAll('.nav-tab');
      const viewTypeInput = document.getElementById('view_type');
      const queueSelect = document.getElementById('queue_name');
      const startDateInput = document.getElementById('start_date');
      const endDateInput = document.getElementById('end_date');
      
      // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
      function saveFilters() {
        const filters = {
          startDate: startDateInput ? startDateInput.value : '',
          endDate: endDateInput ? endDateInput.value : '',
          queue: queueSelect ? queueSelect.value : ''
        };
        localStorage.setItem('asteriskStatsFilters', JSON.stringify(filters));
        return filters;
      }
      
      // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage
      // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–µ—Ä–≤–µ—Ä–æ–º (–∏–∑ URL)
      function restoreFilters() {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL (—Å–µ—Ä–≤–µ—Ä —É–∂–µ –∏—Ö —É—Å—Ç–∞–Ω–æ–≤–∏–ª)
          const urlParams = new URLSearchParams(window.location.search);
          const hasUrlParams = urlParams.has('start_date') || urlParams.has('end_date') || urlParams.has('queue_name');
          
          // –ï—Å–ª–∏ –≤ URL –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ localStorage
          if (!hasUrlParams) {
            const saved = localStorage.getItem('asteriskStatsFilters');
            if (saved) {
              const filters = JSON.parse(saved);
              if (startDateInput && filters.startDate && !startDateInput.value) {
                startDateInput.value = filters.startDate;
              }
              if (endDateInput && filters.endDate && !endDateInput.value) {
                endDateInput.value = filters.endDate;
              }
              // –û—á–µ—Ä–µ–¥—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö
              // –∏ –µ—Å–ª–∏ –º—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –æ—á–µ—Ä–µ–¥–µ–π (–ø–æ–ª–µ –Ω–µ disabled)
              if (queueSelect && filters.queue) {
                const isQueueTab = viewTypeInput && viewTypeInput.value === 'queue';
                if (isQueueTab || !queueSelect.disabled) {
                  queueSelect.value = filters.queue;
                }
              }
            }
          } else {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –≤ localStorage
            const filters = {
              startDate: startDateInput ? startDateInput.value : '',
              endDate: endDateInput ? endDateInput.value : '',
              queue: queueSelect ? queueSelect.value : ''
            };
            localStorage.setItem('asteriskStatsFilters', JSON.stringify(filters));
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', e);
        }
      }
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      restoreFilters();
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
      const urlParams = new URLSearchParams(window.location.search);
      const hasUrlParams = urlParams.has('start_date') || urlParams.has('end_date') || urlParams.has('queue_name');
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL –∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      if (hasUrlParams && form && !document.querySelector('.stats-header-section')) {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ —É—Å–ø–µ–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
        setTimeout(() => {
          if (form.checkValidity()) {
            form.submit();
          }
        }, 100);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
      if (startDateInput) {
        startDateInput.addEventListener('change', saveFilters);
      }
      if (endDateInput) {
        endDateInput.addEventListener('change', saveFilters);
      }
      if (queueSelect) {
        queueSelect.addEventListener('change', saveFilters);
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
      const form = document.querySelector('form[action="/report"]');
      navTabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          const viewType = this.getAttribute('data-view');
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
          const filters = saveFilters();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ view_type
          if (viewTypeInput) {
            viewTypeInput.value = viewType;
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
          if (startDateInput && filters.startDate) {
            startDateInput.value = filters.startDate;
          }
          if (endDateInput && filters.endDate) {
            endDateInput.value = filters.endDate;
          }
          
          // –£–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—è –æ—á–µ—Ä–µ–¥–∏
          if (queueSelect) {
            if (viewType === 'queue') {
              // –î–ª—è –≤–∫–ª–∞–¥–∫–∏ –æ—á–µ—Ä–µ–¥–µ–π - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
              queueSelect.removeAttribute('disabled');
              queueSelect.setAttribute('required', 'required');
              // –í—Å–µ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
              if (filters.queue) {
                queueSelect.value = filters.queue;
              }
            } else {
              // –î–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫ - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
              queueSelect.setAttribute('disabled', 'disabled');
              queueSelect.removeAttribute('required');
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
              if (queueSelect.value) {
                filters.queue = queueSelect.value;
                localStorage.setItem('asteriskStatsFilters', JSON.stringify(filters));
              }
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ
          navTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
          if (form) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            if (form.checkValidity()) {
              form.submit();
            } else {
              // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
              form.reportValidity();
            }
          }
        });
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const currentViewType = viewTypeInput ? viewTypeInput.value : 'queue';
      if (queueSelect) {
        if (currentViewType !== 'queue') {
          queueSelect.setAttribute('disabled', 'disabled');
          queueSelect.removeAttribute('required');
        } else {
          queueSelect.removeAttribute('disabled');
          queueSelect.setAttribute('required', 'required');
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∏–∑ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—á–µ—Ä–µ–¥–µ–π
          const saved = localStorage.getItem('asteriskStatsFilters');
          if (saved) {
            try {
              const filters = JSON.parse(saved);
              if (filters.queue && !queueSelect.value) {
                queueSelect.value = filters.queue;
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏:', e);
            }
          }
        }
      }
      
      // –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–∞—Ç
      const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
      quickFilterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const period = this.getAttribute('data-period');
          const today = new Date();
          let startDate, endDate;
          
          switch(period) {
            case 'today':
              startDate = endDate = today.toISOString().split('T')[0];
              break;
            case 'yesterday':
              const yesterday = new Date(today);
              yesterday.setDate(yesterday.getDate() - 1);
              startDate = endDate = yesterday.toISOString().split('T')[0];
              break;
            case 'week':
              const weekStart = new Date(today);
              weekStart.setDate(today.getDate() - 7);
              startDate = weekStart.toISOString().split('T')[0];
              endDate = today.toISOString().split('T')[0];
              break;
            case 'month':
              const monthStart = new Date(today);
              monthStart.setDate(today.getDate() - 30);
              startDate = monthStart.toISOString().split('T')[0];
              endDate = today.toISOString().split('T')[0];
              break;
            default:
              return;
          }
          
          if (startDateInput) startDateInput.value = startDate;
          if (endDateInput) endDateInput.value = endDate;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
          quickFilterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
          saveFilters();
        });
      });
      
      // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
      const exportBtn = document.getElementById('export-btn');
      if (exportBtn) {
        exportBtn.addEventListener('click', function() {
          <% if (typeof results !== 'undefined' && results && results.calls) { %>
          const calls = <%- JSON.stringify(results.calls) %>;
          const stats = <%- JSON.stringify(results.stats) %>;
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º CSV
          let csv = '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è,–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞,–°—Ç–∞—Ç—É—Å,–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫),–û–∂–∏–¥–∞–Ω–∏–µ (—Å–µ–∫),–ê–≥–µ–Ω—Ç\n';
          calls.forEach(call => {
            const date = call.startTime ? new Date(call.startTime).toLocaleString('ru-RU') : '';
            const number = call.clientNumber || '';
            const status = call.status || '';
            const duration = call.duration || 0;
            const waitTime = call.waitTime || 0;
            const agent = call.agent || '';
            csv += `"${date}","${number}","${status}",${duration},${waitTime},"${agent}"\n`;
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          csv += '\n=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===\n';
          csv += `–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤,${stats.totalCalls}\n`;
          csv += `–ü—Ä–∏–Ω—è—Ç–æ,${stats.answeredCalls}\n`;
          csv += `–ü—Ä–æ–ø—É—â–µ–Ω–æ,${stats.abandonedCalls}\n`;
          csv += `–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞,${stats.answerRate}%\n`;
          csv += `SLA (20 —Å–µ–∫),${stats.slaRate}%\n`;
          
          // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
          const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `asterisk-stats-${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          <% } else { %>
          alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑.');
          <% } %>
        });
      }
    });
  </script>

  <!-- Technical monitoring script -->
  <script>
    // Performance monitoring
    window.addEventListener('load', () => {
      console.log('üöÄ Asterisk Analytics Dashboard loaded');
      console.log('üìä Technical metrics initialized');

      // Monitor page performance
      if ('performance' in window) {
        const perfData = performance.getEntriesByType('navigation')[0];
        console.log(`‚ö° Page load time: ${Math.round(perfData.loadEventEnd - perfData.fetchStart)}ms`);
      }
    });

    // Error monitoring
    window.addEventListener('error', (e) => {
      console.error('üî• Application error:', e.error);
    });

    // Audio playback function
    function playRecording(filename) {
      console.log('üéµ Playing recording:', filename);
      // Implementation in chart.js
    }

    // Generate hourly SVG chart
    function generateHourlyChart() {
      const hourlyDataEl = document.getElementById('hourly-data');
      if (!hourlyDataEl) return;

      const hourlyData = JSON.parse(hourlyDataEl.getAttribute('data-hourly'));
      const chartContainer = document.getElementById('hourly-chart');
      if (!chartContainer) return;

      // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      const containerWidth = chartContainer.parentElement.offsetWidth || 1200;
      const width = Math.max(containerWidth - 40, 800); // –ú–∏–Ω–∏–º—É–º 800px, –≤—ã—á–∏—Ç–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
      const height = 300; // –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞
      const padding = { top: 20, right: 20, bottom: 50, left: 60 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      const barWidth = chartWidth / 24;
      // –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º answered + noCallbacks (–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω)
      const maxValue = Math.max(...Object.values(hourlyData).map(h => {
        const noCallbacks = h.noCallbacks !== undefined ? h.noCallbacks : (h.abandoned || 0);
        return (h.answered || 0) + noCallbacks;
      }), 1);
      const gridLines = 5;

      let svg = `<svg class="hourly-chart-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="hourlyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#0061a6;stop-opacity:1"></stop>
            <stop offset="100%" style="stop-color:#004d84;stop-opacity:1"></stop>
          </linearGradient>
          <linearGradient id="answeredGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1"></stop>
            <stop offset="100%" style="stop-color:#059669;stop-opacity:1"></stop>
          </linearGradient>
        </defs>

        <!-- Grid lines -->`;

      // Grid lines
      svg += '<g class="grid-lines">';
      for (let i = 0; i <= gridLines; i++) {
        const y = padding.top + (chartHeight / gridLines) * i;
        const value = Math.round(maxValue - (maxValue / gridLines) * i);
        svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="rgba(148, 163, 184, 0.15)" stroke-width="1" stroke-dasharray="2,2"></line>`;
        svg += `<text x="${padding.left - 5}" y="${y + 4}" text-anchor="end" fill="#64748b" font-size="10" style="transition: opacity 0.3s 0.2s; opacity: 1;">${value}</text>`;
      }
      svg += '</g>';

      // Calculate trend line (moving average for smoother visualization)
      const trendPoints = [];
      const windowSize = 3; // 3-hour moving average
      for (let hour = 0; hour < 24; hour++) {
        let sum = 0;
        let count = 0;
        for (let i = Math.max(0, hour - Math.floor(windowSize / 2)); i <= Math.min(23, hour + Math.floor(windowSize / 2)); i++) {
          const data = hourlyData[i] || { total: 0, answered: 0, noCallbacks: 0 };
          const noCallbacks = data.noCallbacks !== undefined ? data.noCallbacks : (data.abandoned || 0);
          const hourTotal = (data.answered || 0) + noCallbacks;
          sum += hourTotal;
          count++;
        }
        const avg = count > 0 ? sum / count : 0;
        trendPoints.push({
          hour: hour,
          value: avg,
          x: padding.left + (barWidth * hour) + (barWidth / 2),
          y: padding.top + chartHeight - (avg / maxValue) * chartHeight
        });
      }

      // Bars (stacked: answered bottom, noCallbacks top)
      svg += '<g class="bars">';
      for (let hour = 0; hour < 24; hour++) {
        const data = hourlyData[hour] || { total: 0, answered: 0, abandoned: 0, noCallbacks: 0 };
        const x = padding.left + (barWidth * hour);
        const baseY = padding.top + chartHeight;
        
        // Answered bar (bottom, blue gradient)
        const answeredHeight = data.answered > 0 ? (data.answered / maxValue) * chartHeight : 0;
        const answeredY = baseY - answeredHeight;
        
        // "–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω" bar (top, orange/red) - –∏—Å–ø–æ–ª—å–∑—É–µ–º noCallbacks –≤–º–µ—Å—Ç–æ abandoned
        const noCallbacksValue = data.noCallbacks !== undefined ? data.noCallbacks : data.abandoned;
        const noCallbacksHeight = noCallbacksValue > 0 ? (noCallbacksValue / maxValue) * chartHeight : 0;
        const noCallbacksY = answeredY - noCallbacksHeight;
        
        const isPeak = data.total === maxValue && data.total > 0;

        svg += `<g class="hour-bar" data-hour="${hour}" data-total="${data.total}" data-answered="${data.answered}" data-abandoned="${noCallbacksValue}">`;
        
        // Answered bar (blue gradient) - bottom part
        if (data.answered > 0) {
          const answeredFill = isPeak ? '#0061a6' : 'url(#hourlyGradient)';
          svg += `<rect x="${x}" y="${answeredY}" width="${barWidth - 2}" height="${answeredHeight}" fill="${answeredFill}" rx="2" ry="2" style="opacity: 1; transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);" class="bar-rect bar-answered"></rect>`;
        }
        
        // "–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω" bar (orange) - top part
        if (noCallbacksValue > 0) {
          const noCallbacksFill = isPeak ? '#f59e0b' : '#f59e0b';
          svg += `<rect x="${x}" y="${noCallbacksY}" width="${barWidth - 2}" height="${noCallbacksHeight}" fill="${noCallbacksFill}" rx="2" ry="2" style="opacity: 1; transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);" class="bar-rect bar-abandoned"></rect>`;
        }
        
        // Total label on top
        if (data.total > 0) {
          const labelY = noCallbacksY > 0 ? noCallbacksY - 5 : (answeredY > 0 ? answeredY - 5 : baseY - 5);
          svg += `<text x="${x + barWidth / 2}" y="${labelY}" text-anchor="middle" fill="#64748b" font-size="9" font-weight="600" style="opacity: 1; transition: opacity 0.3s 0.2s;">${data.total}</text>`;
        }
        
        svg += '</g>';
      }
      svg += '</g>';

      // Draw trend line AFTER bars (so it appears on top)
      svg += '<g class="trend-line">';
      let trendPath = '';
      trendPoints.forEach((point, index) => {
        if (index === 0) {
          trendPath += `M ${point.x} ${point.y}`;
        } else {
          trendPath += ` L ${point.x} ${point.y}`;
        }
      });
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏—Ä—é–∑–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ —Å —Å–∏–Ω–∏–º –∏ –æ—Ä–∞–Ω–∂–µ–≤—ã–º
      svg += `<path d="${trendPath}" fill="none" stroke="#06b6d4" stroke-width="3" stroke-dasharray="5,3" opacity="1" class="trend-path"></path>`;
      
      // Add trend line points
      trendPoints.forEach(point => {
        if (point.value > 0) {
          svg += `<circle cx="${point.x}" cy="${point.y}" r="4" fill="#06b6d4" opacity="1" stroke="#ffffff" stroke-width="1.5" class="trend-point"></circle>`;
        }
      });
      svg += '</g>';
      
      // Legend
      svg += '<g class="chart-legend">';
      const legendY = padding.top - 10;
      svg += `<circle cx="${padding.left + 20}" cy="${legendY}" r="5" fill="url(#hourlyGradient)"></circle>`;
      svg += `<text x="${padding.left + 30}" y="${legendY + 4}" fill="#64748b" font-size="10">–û—Ç–≤–µ—á–µ–Ω–Ω—ã–µ</text>`;
      svg += `<circle cx="${padding.left + 120}" cy="${legendY}" r="5" fill="#f59e0b"></circle>`;
      svg += `<text x="${padding.left + 130}" y="${legendY + 4}" fill="#64748b" font-size="10">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</text>`;
      svg += `<line x1="${padding.left + 220}" y1="${legendY}" x2="${padding.left + 240}" y2="${legendY}" stroke="#06b6d4" stroke-width="3" stroke-dasharray="5,3" opacity="1"></line>`;
      svg += `<text x="${padding.left + 245}" y="${legendY + 4}" fill="#64748b" font-size="10">–¢—Ä–µ–Ω–¥</text>`;
      svg += '</g>';

      // Hour labels
      const labelHours = [0, 3, 6, 9, 12, 15, 18, 21];
      labelHours.forEach(hour => {
        const x = padding.left + (barWidth * hour) + (barWidth / 2);
        const label = hour.toString().padStart(2, '0') + ':00';
        svg += `<text x="${x}" y="${height - 10}" text-anchor="middle" fill="#64748b" font-size="10" font-weight="500" style="transition: opacity 0.3s 0.2s; opacity: 1;">${label}</text>`;
      });

      svg += '</svg>';
      chartContainer.innerHTML = svg;
      
      // Add tooltip event listeners
      setupChartTooltips();
    }
    
    // Setup tooltip for chart bars
    function setupChartTooltips() {
      const tooltip = document.getElementById('chart-tooltip');
      if (!tooltip) return;
      
      const hourBars = document.querySelectorAll('.hour-bar');
      const chartContainer = document.querySelector('.hourly-chart-container');
      
      hourBars.forEach(bar => {
        const rects = bar.querySelectorAll('rect');
        
        rects.forEach(rect => {
          rect.addEventListener('mouseenter', (e) => {
            const hour = parseInt(bar.getAttribute('data-hour'));
            const total = parseInt(bar.getAttribute('data-total'));
            const answered = parseInt(bar.getAttribute('data-answered'));
            const abandoned = parseInt(bar.getAttribute('data-abandoned'));
            
            if (total === 0) return;
            
            // Update tooltip content
            document.getElementById('tooltip-time').textContent = `${hour.toString().padStart(2, '0')}:00`;
            document.getElementById('tooltip-total').textContent = total;
            document.getElementById('tooltip-answered').textContent = answered;
            document.getElementById('tooltip-abandoned').textContent = abandoned;
            
            // Show tooltip
            tooltip.style.display = 'block';
            
            // Position tooltip
            updateTooltipPosition(e, tooltip, chartContainer);
          });
          
          rect.addEventListener('mousemove', (e) => {
            if (tooltip.style.display === 'block') {
              updateTooltipPosition(e, tooltip, chartContainer);
            }
          });
          
          rect.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
          });
        });
      });
    }
    
    function updateTooltipPosition(e, tooltip, container) {
      const containerRect = container.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      
      let x = e.clientX - containerRect.left + 10;
      let y = e.clientY - containerRect.top - tooltipRect.height - 10;
      
      // Adjust if tooltip goes outside container
      if (x + tooltipRect.width > containerRect.width) {
        x = e.clientX - containerRect.left - tooltipRect.width - 10;
      }
      if (y < 0) {
        y = e.clientY - containerRect.top + 10;
      }
      
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }

    // Initialize chart on load
    if (document.getElementById('hourly-data')) {
      generateHourlyChart();
    }
  </script>
</body>
</html>