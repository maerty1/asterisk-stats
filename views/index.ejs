<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ - –ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Asterisk PBX">
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</title>
  <link rel="stylesheet" href="/css/style.css?v=<%= Date.now() %>">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="/js/status-monitor.js?v=<%= Date.now() %>" defer></script>
  <script src="/js/call-center-stats.js?v=<%= Date.now() %>" defer></script>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo-icon">‚ö°</div>
          <div class="logo-text">
            <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</h1>
            <div class="logo-subtitle">–ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</div>
          </div>
        </div>
        <div class="header-status-group">
          <div class="performance-indicator" id="system-status">
            <span id="status-indicator">‚óè</span>
            <span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>
          <div class="tech-metric" id="current-time"><%= new Date().toLocaleTimeString('ru-RU') %></div>
        </div>
      </div>
    
      <div class="header-form-container">
        <form method="POST" action="/report" id="main-form">
          <input type="hidden" name="view_type" value="<%= typeof viewType !== 'undefined' ? viewType : 'queue' %>" id="view_type">
          
          <div class="quick-filters">
            <!-- Quick Date Filters -->
            <div class="view-selector-group">
              <button type="button" class="view-selector-btn quick-date-filter-btn" data-period="today">–°–µ–≥–æ–¥–Ω—è</button>
              <button type="button" class="view-selector-btn quick-date-filter-btn" data-period="yesterday">–í—á–µ—Ä–∞</button>
              <button type="button" class="view-selector-btn quick-date-filter-btn" data-period="week">–ù–µ–¥–µ–ª—è</button>
              <button type="button" class="view-selector-btn quick-date-filter-btn" data-period="month">–ú–µ—Å—è—Ü</button>
            </div>
            
            <!-- View Type Selector -->
            <div class="view-selector-group">
              <button type="button" class="view-selector-btn <%= typeof viewType === 'undefined' || viewType === 'queue' ? 'active' : '' %>" data-view="queue">
                <span class="view-selector-icon">üìû</span>
                <span class="view-selector-text">–í—Ö –æ—á–µ—Ä–µ–¥—å</span>
              </button>
              <button type="button" class="view-selector-btn <%= viewType === 'outbound_queue' ? 'active' : '' %>" data-view="outbound_queue">
                <span class="view-selector-icon">üìû</span>
                <span class="view-selector-text">–ò—Å—Ö –æ—á–µ—Ä–µ–¥–∏</span>
              </button>
              <button type="button" class="view-selector-btn <%= viewType === 'inbound' ? 'active' : '' %>" data-view="inbound">
                <span class="view-selector-icon">üì•</span>
                <span class="view-selector-text">–í—Ö–æ–¥—è—â–∏–µ</span>
              </button>
              <button type="button" class="view-selector-btn <%= viewType === 'outbound' ? 'active' : '' %>" data-view="outbound">
                <span class="view-selector-icon">üì§</span>
                <span class="view-selector-text">–ò—Å—Ö–æ–¥—è—â–∏–µ</span>
              </button>
              <a href="/rankings" class="view-selector-btn">
                <span class="view-selector-icon">üèÜ</span>
                <span class="view-selector-text">–†–µ–π—Ç–∏–Ω–≥</span>
              </a>
            </div>
            
            <!-- Action Buttons -->
            <div class="view-selector-group">
              <% if (typeof viewType === 'undefined' || viewType === 'queue' || viewType === 'outbound_queue') { %>
              <button type="button" class="view-selector-btn" id="open-email-modal-btn" title="Email —Ä–∞—Å—Å—ã–ª–∫–∞">
                <span class="view-selector-icon">üìß</span>
              </button>
              <% } %>
              <button type="button" class="view-selector-btn" id="open-settings-modal-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <span class="view-selector-icon">‚öôÔ∏è</span>
              </button>
              <button type="button" class="view-selector-btn" id="export-btn" title="–≠–∫—Å–ø–æ—Ä—Ç">
                <span class="view-selector-icon">üì•</span>
              </button>
            </div>
          </div>
          
          <div class="form-row" style="grid-template-columns: 2fr 1.5fr auto;">
            <div class="form-group">
              <label for="queue_name">–û—á–µ—Ä–µ–¥—å</label>
              <select id="queue_name" name="queue_name" <%= (typeof viewType === 'undefined' || viewType === 'queue' || viewType === 'outbound_queue') ? 'required' : '' %> <%= typeof viewType !== 'undefined' && (viewType === 'inbound' || viewType === 'outbound') ? 'disabled' : '' %>>
                <% if (queues && queues.length > 0) { %>
                  <% queues.forEach(queue => { %>
                    <option value="<%= queue %>" <%= queue === selectedQueue ? 'selected' : '' %>><%= typeof helpers !== 'undefined' && helpers.formatQueueName ? helpers.formatQueueName(queue) : queue %></option>
                  <% }); %>
                <% } else { %>
                  <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                <% } %>
              </select>
            </div>
            
            <div class="form-group">
              <label for="date_range">–ü–µ—Ä–∏–æ–¥</label>
              <input type="text" id="date_range" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥" style="cursor: pointer;" readonly>
              <input type="hidden" id="start_date" name="start_date" value="<%= startDate %>">
              <input type="hidden" id="end_date" name="end_date" value="<%= endDate %>">
            </div>
            
            <div class="form-group" style="align-self: flex-end;">
              <button type="submit" class="btn btn-primary" style="min-width: 140px;">
                <span>‚ñ∂</span> –ê–Ω–∞–ª–∏–∑
              </button>
            </div>
          </div>
        </form>
      </div>
    </header>

    <main>
      <% if (!results) { %>
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <h3 class="empty-state-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
          <p class="empty-state-description">–£–∫–∞–∂–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–≤–æ–Ω–∫–æ–≤</p>
        </div>
      <% } else if (results.error) { %>
        <div class="card" style="border-color: var(--accent-error);">
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <h3 class="empty-state-title">–û—à–∏–±–∫–∞</h3>
            <p class="empty-state-description"><%= results.error %></p>
          </div>
        </div>
      <% } else { %>
        <!-- KPI Cards -->
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-icon">üìû</div>
            <div class="kpi-label">–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</div>
            <div class="kpi-value"><%= results.stats.totalCalls %></div>
          </div>
          <div class="kpi-card success">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞</div>
            <div class="kpi-value"><%= results.stats.answerRate %>%</div>
            <div class="kpi-subtitle"><%= results.stats.answeredCalls %> –∏–∑ <%= results.stats.totalCalls %></div>
          </div>
          <div class="kpi-card error">
            <div class="kpi-icon">‚ùå</div>
            <div class="kpi-label">–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ</div>
            <div class="kpi-value"><%= results.stats.abandonedCalls %></div>
            <div class="kpi-subtitle"><%= results.stats.totalCalls > 0 ? Math.round(results.stats.abandonedCalls / results.stats.totalCalls * 100) : 0 %>% –æ—Ç –æ–±—â–µ–≥–æ</div>
          </div>
          <% if (typeof viewType === 'undefined' || viewType === 'queue' || viewType === 'outbound_queue') { %>
          <div class="kpi-card warning">
            <div class="kpi-icon">‚è±Ô∏è</div>
            <div class="kpi-label">SLA (20 —Å–µ–∫)</div>
            <div class="kpi-value"><%= results.stats.slaRate %>%</div>
          </div>
          <% } %>
        </div>

        <!-- Callbacks Section -->
        <div class="callback-section">
          <h3 class="callback-title"><span>‚Ü©Ô∏è</span> –ü–µ—Ä–µ–∑–≤–æ–Ω—ã –∏ –≤—Ä–µ–º—è</h3>
          <div class="callback-grid">
            <div class="callback-item">
              <div class="callback-item-label">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª —Å–∞–º</div>
              <div class="callback-item-value"><%= results.stats.clientCallbacks || 0 %></div>
            </div>
            <div class="callback-item success">
              <div class="callback-item-label">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏–ª–∏ –º—ã</div>
              <div class="callback-item-value"><%= results.stats.agentCallbacks || 0 %></div>
            </div>
            <div class="callback-item error">
              <div class="callback-item-label">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</div>
              <% 
                const clientCb = results.stats.clientCallbacks || 0;
                const agentCb = results.stats.agentCallbacks || 0;
                const notProcessed = results.stats.abandonedCalls - clientCb - agentCb;
              %>
              <div class="callback-item-value"><%= notProcessed >= 0 ? notProcessed : 0 %></div>
            </div>
            <div class="callback-item">
              <div class="callback-item-label">–°—Ä. –æ–∂–∏–¥–∞–Ω–∏–µ</div>
              <% 
                const avgWaitTime = results.stats.avgWaitTimeAnswered || results.stats.avgWaitTime || 0;
                const avgWaitMin = Math.floor(avgWaitTime / 60);
                const avgWaitSec = Math.round(avgWaitTime % 60);
              %>
              <div class="callback-item-value"><%= avgWaitMin %>:<%= avgWaitSec < 10 ? '0' : '' %><%= avgWaitSec %></div>
            </div>
            <div class="callback-item">
              <div class="callback-item-label">–°—Ä. —Ä–∞–∑–≥–æ–≤–æ—Ä</div>
              <% 
                const avgDurMin = Math.floor(results.stats.avgDuration / 60);
                const avgDurSec = results.stats.avgDuration % 60;
              %>
              <div class="callback-item-value"><%= avgDurMin %>:<%= avgDurSec < 10 ? '0' : '' %><%= avgDurSec %></div>
            </div>
            <div class="callback-item">
              <div class="callback-item-label">–ü–∏–∫–æ–≤—ã–π —á–∞—Å</div>
              <div class="callback-item-value"><%= results.stats.peakHour %></div>
            </div>
            <% if (typeof viewType === 'undefined' || viewType === 'queue' || viewType === 'outbound_queue') { %>
            <div class="callback-item">
              <div class="callback-item-label">ASA</div>
              <% 
                const asa = results.stats.asa || 0;
                const asaMin = Math.floor(asa / 60);
                const asaSec = asa % 60;
              %>
              <div class="callback-item-value"><%= asaMin %>:<%= asaSec < 10 ? '0' : '' %><%= asaSec %></div>
            </div>
            <% } %>
          </div>
        </div>
          </div>
        </section>

        <!-- Technical Dashboard Layout -->
        <div class="main-dashboard">
            <!-- Performance Chart -->
            <section class="chart-section">
              <div class="hourly-chart-container">
                <div class="hourly-chart-svg" id="hourly-chart">
                  <!-- SVG –≥—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω JavaScript -->
      </div>
                <div class="chart-tooltip" id="chart-tooltip" style="display: none;">
                  <div class="tooltip-time" id="tooltip-time"></div>
                  <div class="tooltip-stats">
                    <div class="tooltip-stat">
                      <span class="tooltip-label">–í—Å–µ–≥–æ:</span>
                      <span class="tooltip-value" id="tooltip-total">0</span>
      </div>
                    <div class="tooltip-stat">
                      <span class="tooltip-label answered">–û—Ç–≤–µ—á–µ–Ω–Ω—ã–µ:</span>
                      <span class="tooltip-value" id="tooltip-answered">0</span>
    </div>
                    <div class="tooltip-stat">
                      <span class="tooltip-label abandoned">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω:</span>
                      <span class="tooltip-value" id="tooltip-abandoned">0</span>
  </div>
  </div>
      </div>
      </div>
            </section>

            <!-- Detailed Data Table -->
            <section class="table-section">
              <div class="table-header">
                <h3 class="table-title">–î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –∑–≤–æ–Ω–∫–æ–≤</h3>
                <div class="table-controls">
                  <div class="items-per-page">
                    <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å:</label>
                    <select id="items-per-page">
                      <option value="10">10</option>
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
    </div>
                  <div class="table-search">
                    <input type="text" id="table-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, —Å—Ç–∞—Ç—É—Å—É...">
    </div>
  </div>
</div>

              <div class="table-container">
                <table class="data-table" role="table" aria-label="Technical call log">
                    <thead>
                      <tr>
                      <th scope="col" data-sort="date" class="sortable">
                        –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="client" class="sortable">
                        –ù–æ–º–µ—Ä –∞–±–æ–Ω–µ–Ω—Ç–∞ <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="wait" class="sortable">
                        –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="duration" class="sortable">
                        –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <span class="sort-icon"></span>
                      </th>
                      <th scope="col" data-sort="status" class="sortable">
                        –°—Ç–∞—Ç—É—Å <span class="sort-icon"></span>
                      </th>
                      <th scope="col">–ó–∞–ø–∏—Å—å</th>
                      </tr>
                    </thead>
                  <tbody id="calls-tbody">
                      <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π -->
                    </tbody>
                  </table>
                </div>

              <div class="pagination-section">
                <div class="pagination-info" id="pagination-info">
                  –ü–æ–∫–∞–∑–∞–Ω–æ 1-<%= Math.min(results.calls.length, 25) %> –∏–∑ <%= results.stats.totalCalls %> –∑–∞–ø–∏—Å–µ–π
            </div>
                <div class="pagination-controls" id="pagination-controls">
                  <!-- Pagination buttons will be generated by JavaScript -->
          </div>
      </div>
            </section>
    </div>
                </div>
              <% } %>

      <!-- Toast Notifications Container -->
      <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container" style="z-index: 9999;">
            </div>

      <!-- Email Management Modal -->
      <div id="email-modal" class="modal" style="display: none;">
        <div class="modal-overlay" id="email-modal-overlay"></div>
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">üìß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ email —Ä–∞—Å—Å—ã–ª–∫–æ–π</h2>
            <button type="button" class="modal-close" id="close-email-modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
              <span>√ó</span>
            </button>
          </div>
          <div class="modal-body">
            <div style="margin-bottom: var(--md-spacing-lg);">
              <label for="modal-email-queue-select" class="form-label">–û—á–µ—Ä–µ–¥—å:</label>
              <select id="modal-email-queue-select" class="form-input">
                <% if (queues && queues.length > 0) { %>
                  <% queues.forEach(queue => { %>
                    <option value="<%= queue %>" <%= queue === selectedQueue ? 'selected' : '' %>><%= typeof helpers !== 'undefined' && helpers.formatQueueName ? helpers.formatQueueName(queue) : queue %></option>
                  <% }); %>
                <% } else { %>
                  <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
        <% } %>
              </select>
      </div>
            <div style="display: flex; gap: var(--md-spacing-sm); margin-bottom: var(--md-spacing-lg); align-items: flex-end;">
              <div style="flex: 1;">
                <label for="modal-email-input" class="form-label">Email –∞–¥—Ä–µ—Å:</label>
                <input type="email" id="modal-email-input" class="form-input" placeholder="example@company.com">
    </div>
              <button type="button" class="export-btn" id="modal-add-email-btn" style="white-space: nowrap;">
                <span class="btn-icon">‚ûï</span>
                <span>–î–æ–±–∞–≤–∏—Ç—å</span>
              </button>
            </div>
            <div id="modal-email-list" style="max-height: 400px; overflow-y: auto;">
              <!-- –°–ø–∏—Å–æ–∫ email –∞–¥—Ä–µ—Å–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
              <div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: var(--md-spacing-md);">
                –í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ email –∞–¥—Ä–µ—Å–æ–≤
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Management Modal -->
      <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-overlay" id="settings-modal-overlay"></div>
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h2 class="modal-title">‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button type="button" class="modal-close" id="close-settings-modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
              <span>√ó</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="settings-loading" style="text-align: center; padding: var(--md-spacing-lg);">
              <div>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>
            </div>
            <div id="settings-form" style="display: none;">
              <div style="display: grid; gap: var(--md-spacing-lg);">
                <!-- Database Settings -->
                <div>
                  <h3 style="margin: 0 0 var(--md-spacing-md) 0; font-size: 1rem; font-weight: 600; color: var(--md-sys-color-on-surface);">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                  <div style="display: grid; gap: var(--md-spacing-md);">
                    <div>
                      <label class="form-label">–•–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</label>
                      <input type="text" class="form-input" id="setting-DB_HOST" placeholder="localhost">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--md-spacing-md);">
                      <div>
                        <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <input type="text" class="form-input" id="setting-DB_USER" placeholder="freepbxuser">
                      </div>
                      <div>
                        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-input" id="setting-DB_PASS" placeholder="password">
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--md-spacing-md);">
                      <div>
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</label>
                        <input type="text" class="form-input" id="setting-DB_NAME" placeholder="asterisk">
                      </div>
                      <div>
                        <label class="form-label">–ê–¥–∞–ø—Ç–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</label>
                        <select class="form-input" id="setting-DB_ADAPTER">
                          <option value="mysql2">mysql2</option>
                          <option value="sequelize">sequelize</option>
                          <option value="knex">knex</option>
                          <option value="objection">objection</option>
                          <option value="bookshelf">bookshelf</option>
                          <option value="typeorm">typeorm</option>
                        </select>
                      </div>
                    </div>
                    <div>
                      <label class="form-label">–õ–∏–º–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</label>
                      <input type="number" class="form-input" id="setting-DB_CONNECTION_LIMIT" placeholder="20" min="1">
                    </div>
                  </div>
                </div>

                <!-- SMTP Settings -->
                <div>
                  <h3 style="margin: 0 0 var(--md-spacing-md) 0; font-size: 1rem; font-weight: 600; color: var(--md-sys-color-on-surface);">SMTP (Email)</h3>
                  <div style="display: grid; gap: var(--md-spacing-md);">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--md-spacing-md);">
                      <div>
                        <label class="form-label">SMTP —Å–µ—Ä–≤–µ—Ä</label>
                        <input type="text" class="form-input" id="setting-SMTP_HOST" placeholder="smtp.gmail.com">
                      </div>
                      <div>
                        <label class="form-label">–ü–æ—Ä—Ç</label>
                        <input type="number" class="form-input" id="setting-SMTP_PORT" placeholder="587" min="1" max="65535">
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--md-spacing-md);">
                      <div>
                        <label class="form-label">Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="email" class="form-input" id="setting-SMTP_USER" placeholder="your_email@gmail.com">
                      </div>
                      <div>
                        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-input" id="setting-SMTP_PASS" placeholder="password">
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--md-spacing-md);">
                      <div>
                        <label class="form-label">–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (TLS/SSL)</label>
                        <select class="form-input" id="setting-SMTP_SECURE">
                          <option value="false">–ù–µ—Ç</option>
                          <option value="true">–î–∞</option>
                        </select>
                      </div>
                      <div>
                        <label class="form-label">–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</label>
                        <input type="text" class="form-input" id="setting-EMAIL_FROM_NAME" placeholder="Asterisk Analytics">
                      </div>
                    </div>
                    <div>
                      <label class="form-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ (Cron)</label>
                      <input type="text" class="form-input" id="setting-EMAIL_CRON_SCHEDULE" placeholder="59 23 * * *">
                    </div>
                  </div>
                </div>

                <!-- Server Settings -->
                <div>
                  <h3 style="margin: 0 0 var(--md-spacing-md) 0; font-size: 1rem; font-weight: 600; color: var(--md-sys-color-on-surface);">–°–µ—Ä–≤–µ—Ä</h3>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--md-spacing-md);">
                    <div>
                      <label class="form-label">–ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞</label>
                      <input type="number" class="form-input" id="setting-PORT" placeholder="3000" min="1" max="65535">
                    </div>
                    <div>
                      <label class="form-label">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
                      <input type="text" class="form-input" id="setting-TZ" placeholder="Europe/Moscow">
                    </div>
                  </div>
                </div>

                <!-- Other Settings -->
                <div>
                  <h3 style="margin: 0 0 var(--md-spacing-md) 0; font-size: 1rem; font-weight: 600; color: var(--md-sys-color-on-surface);">–ü—Ä–æ—á–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                  <div style="display: grid; gap: var(--md-spacing-md);">
                    <div>
                      <label class="form-label">–ü—É—Ç—å –∫ –∑–∞–ø–∏—Å—è–º —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤</label>
                      <input type="text" class="form-input" id="setting-RECORDINGS_PATH" placeholder="/var/spool/asterisk/monitor">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--md-spacing-md);">
                      <div>
                        <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö</label>
                        <input type="number" class="form-input" id="setting-OUTBOUND_MIN_LENGTH" placeholder="4" min="1">
                      </div>
                      <div>
                        <label class="form-label">–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –æ—á–µ—Ä–µ–¥–µ–π (–º—Å)</label>
                        <input type="number" class="form-input" id="setting-QUEUES_CACHE_TTL" placeholder="3600000" min="0">
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--md-spacing-md);">
                      <div>
                        <label class="form-label">–£–ª—å—Ç—Ä–∞-–±—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã</label>
                        <select class="form-input" id="setting-USE_ULTRA_FAST_QUERIES">
                          <option value="true">–í–∫–ª—é—á–µ–Ω–æ</option>
                          <option value="false">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
                        </select>
                      </div>
                      <div>
                        <label class="form-label">–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</label>
                        <select class="form-input" id="setting-USE_PARALLEL_QUERIES">
                          <option value="true">–í–∫–ª—é—á–µ–Ω–æ</option>
                          <option value="false">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
                        </select>
                      </div>
                      <div>
                        <label class="form-label">–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏</label>
                        <select class="form-input" id="setting-DEBUG">
                          <option value="false">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
                          <option value="true">–í–∫–ª—é—á–µ–Ω–æ</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: var(--md-spacing-md); justify-content: flex-end; margin-top: var(--md-spacing-lg); padding-top: var(--md-spacing-lg); border-top: 1px solid var(--md-sys-color-outline);">
                <button type="button" class="export-btn" id="settings-cancel-btn" style="background: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="export-btn" id="settings-save-btn">
                  üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden data for JavaScript -->
      <% if (results && results.calls && results.calls.length > 0) { %>
        <div id="chart-data" data-chart='<%- JSON.stringify(results).replace(/'/g, '&#39;') %>' style="display: none;"></div>
        <div id="calls-data" data-calls='<%- JSON.stringify(results.calls).replace(/'/g, '&#39;') %>' style="display: none;"></div>
        <div id="hourly-data" data-hourly='<%- JSON.stringify(results.stats.callsByHour).replace(/'/g, '&#39;') %>' style="display: none;"></div>
      <% } %>
  </main>
    </div>

  <!-- Scripts -->
  <!-- Status Monitor - Independent module -->
  <script src="/js/status-monitor.js?v=<%= Date.now() %>"></script>
  
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/js/chart.js?v=<%= Date.now() %>"></script>
  
  <!-- Email Management Modal Script -->
  <script>
    (function() {
      const emailModal = document.getElementById('email-modal');
      const emailModalOverlay = document.getElementById('email-modal-overlay');
      const closeEmailModal = document.getElementById('close-email-modal');
      const openEmailModalBtn = document.getElementById('open-email-modal-btn');
      const modalEmailQueueSelect = document.getElementById('modal-email-queue-select');
      const modalEmailInput = document.getElementById('modal-email-input');
      const modalAddEmailBtn = document.getElementById('modal-add-email-btn');
      const modalEmailList = document.getElementById('modal-email-list');
      
      if (!emailModal || !openEmailModalBtn) {
        return; // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—á–µ—Ä–µ–¥–µ–π)
      }
      
      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      openEmailModalBtn.addEventListener('click', () => {
        emailModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        if (modalEmailQueueSelect.value) {
          loadModalEmailList();
        }
      });
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      function closeModal() {
        emailModal.style.display = 'none';
        document.body.style.overflow = '';
      }
      
      closeEmailModal.addEventListener('click', closeModal);
      emailModalOverlay.addEventListener('click', closeModal);
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && emailModal.style.display === 'flex') {
          closeModal();
  }
      });
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ email –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
      async function loadModalEmailList() {
        const queueName = modalEmailQueueSelect.value;
        if (!queueName) {
          modalEmailList.innerHTML = '<div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: var(--md-spacing-md);">–í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å</div>';
          return;
        }
        
        try {
          modalEmailList.innerHTML = '<div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: var(--md-spacing-md);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
          
          const response = await fetch(`/api/email-reports/${encodeURIComponent(queueName)}`);
          const data = await response.json();
          
          if (data.success && data.emails && data.emails.length > 0) {
            modalEmailList.innerHTML = data.emails.map(email => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--md-spacing-sm) var(--md-spacing-md); background: var(--md-sys-color-surface-variant); border-radius: var(--md-radius-sm); margin-bottom: var(--md-spacing-xs);">
                <div style="flex: 1;">
                  <div style="font-weight: 500; color: var(--md-sys-color-on-surface);">${email.email}</div>
                  <div style="font-size: 0.75rem; color: var(--md-sys-color-on-surface-variant);">
                    ${email.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚è∏ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'} ‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω: ${new Date(email.created_at).toLocaleDateString('ru-RU')}
        </div>
                </div>
                <div style="display: flex; gap: var(--md-spacing-xs);">
                  <button type="button" class="export-btn" style="padding: var(--md-spacing-xs) var(--md-spacing-sm); font-size: 0.75rem;" onclick="toggleModalEmailStatus(${email.id}, ${!email.is_active})" title="${email.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}">
                    ${email.is_active ? '‚è∏' : '‚ñ∂'}
                  </button>
                  <button type="button" class="export-btn" style="padding: var(--md-spacing-xs) var(--md-spacing-sm); font-size: 0.75rem; background: var(--md-sys-color-error);" onclick="deleteModalEmail(${email.id})" title="–£–¥–∞–ª–∏—Ç—å">
                    üóëÔ∏è
                  </button>
                </div>
              </div>
            `).join('');
          } else {
            modalEmailList.innerHTML = '<div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: var(--md-spacing-md);">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö email –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏</div>';
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ email –∞–¥—Ä–µ—Å–æ–≤:', error);
          modalEmailList.innerHTML = '<div style="text-align: center; color: var(--md-sys-color-error); padding: var(--md-spacing-md);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ email –∞–¥—Ä–µ—Å–æ–≤</div>';
        }
      }
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ email –∞–¥—Ä–µ—Å–∞
      modalAddEmailBtn.addEventListener('click', async () => {
        const queueName = modalEmailQueueSelect.value;
        const email = modalEmailInput.value.trim();
        
        if (!queueName) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å');
    return;
  }

        if (!email) {
          alert('–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å');
          return;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email –∞–¥—Ä–µ—Å–∞');
          return;
        }
        
        try {
          modalAddEmailBtn.disabled = true;
          modalAddEmailBtn.innerHTML = '<span class="btn-icon">‚è≥</span><span>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...</span>';
          
          const response = await fetch('/api/email-reports', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ queue_name: queueName, email: email })
          });
          
          const data = await response.json();
          
          if (data.success) {
            modalEmailInput.value = '';
            loadModalEmailList();
            showToast('‚úÖ Email –∞–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è email:', error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ email –∞–¥—Ä–µ—Å–∞');
        } finally {
          modalAddEmailBtn.disabled = false;
          modalAddEmailBtn.innerHTML = '<span class="btn-icon">‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å</span>';
        }
      });
      
      // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ email
      modalEmailQueueSelect.addEventListener('change', loadModalEmailList);
      
      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Å–ø–∏—Å–∫–µ
      window.toggleModalEmailStatus = async function(id, isActive) {
        try {
          const response = await fetch(`/api/email-reports/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: isActive })
          });
          
          const data = await response.json();
          
          if (data.success) {
            loadModalEmailList();
            showToast(isActive ? '‚úÖ Email –∞–¥—Ä–µ—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '‚è∏ Email –∞–¥—Ä–µ—Å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ email:', error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ email –∞–¥—Ä–µ—Å–∞');
        }
      };
      
      window.deleteModalEmail = async function(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç email –∞–¥—Ä–µ—Å?')) {
        return;
      }
      
        try {
          const response = await fetch(`/api/email-reports/${id}`, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (data.success) {
            loadModalEmailList();
            showToast('‚úÖ Email –∞–¥—Ä–µ—Å —É–¥–∞–ª–µ–Ω', 'success');
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è email:', error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ email –∞–¥—Ä–µ—Å–∞');
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        toast.className = `alert alert-${type}`;
        toast.style.cssText = 'margin-bottom: var(--md-spacing-sm); animation: slideIn 0.3s ease;';
        toast.innerHTML = `<span>${message}</span>`;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    })();
  </script>
  
  <!-- Settings Management Modal Script -->
  <script>
    (function() {
      const settingsModal = document.getElementById('settings-modal');
      const settingsModalOverlay = document.getElementById('settings-modal-overlay');
      const closeSettingsModal = document.getElementById('close-settings-modal');
      const openSettingsModalBtn = document.getElementById('open-settings-modal-btn');
      const settingsForm = document.getElementById('settings-form');
      const settingsLoading = document.getElementById('settings-loading');
      const settingsSaveBtn = document.getElementById('settings-save-btn');
      const settingsCancelBtn = document.getElementById('settings-cancel-btn');
      
      if (!settingsModal || !openSettingsModalBtn) {
        return;
      }
      
      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      openSettingsModalBtn.addEventListener('click', async () => {
        settingsModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        settingsForm.style.display = 'none';
        settingsLoading.style.display = 'block';
        
        try {
          const response = await fetch('/api/settings');
          const data = await response.json();
          
          if (data.success && data.settings) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            Object.keys(data.settings).forEach(key => {
              const input = document.getElementById(`setting-${key}`);
              if (input) {
                input.value = data.settings[key] || '';
              }
            });
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
          showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        } finally {
          settingsLoading.style.display = 'none';
          settingsForm.style.display = 'block';
        }
      });
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      function closeSettingsModal() {
        settingsModal.style.display = 'none';
        document.body.style.overflow = '';
      }
      
      closeSettingsModal.addEventListener('click', closeSettingsModal);
      settingsModalOverlay.addEventListener('click', closeSettingsModal);
      settingsCancelBtn.addEventListener('click', closeSettingsModal);
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsModal.style.display === 'flex') {
          closeSettingsModal();
        }
      });
      
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
      settingsSaveBtn.addEventListener('click', async () => {
        try {
          settingsSaveBtn.disabled = true;
          settingsSaveBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
          
          // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã
          const settings = {};
          const inputs = settingsForm.querySelectorAll('[id^="setting-"]');
          inputs.forEach(input => {
            const key = input.id.replace('setting-', '');
            settings[key] = input.value.trim();
          });
          
          const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ settings })
          });
          
          const data = await response.json();
          
          if (data.success) {
            showToast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.', 'success');
            setTimeout(() => {
              closeSettingsModal();
            }, 1500);
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
        } finally {
          settingsSaveBtn.disabled = false;
          settingsSaveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
        }
      });
    })();
  </script>
  
  <!-- Settings Management Modal Script -->
  <script>
    (function() {
      const settingsModal = document.getElementById('settings-modal');
      const settingsModalOverlay = document.getElementById('settings-modal-overlay');
      const closeSettingsModal = document.getElementById('close-settings-modal');
      const openSettingsModalBtn = document.getElementById('open-settings-modal-btn');
      const settingsForm = document.getElementById('settings-form');
      const settingsLoading = document.getElementById('settings-loading');
      const settingsSaveBtn = document.getElementById('settings-save-btn');
      const settingsCancelBtn = document.getElementById('settings-cancel-btn');
      
      if (!settingsModal || !openSettingsModalBtn) {
        return;
      }
      
      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      openSettingsModalBtn.addEventListener('click', async () => {
        settingsModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        settingsForm.style.display = 'none';
        settingsLoading.style.display = 'block';
        
        try {
          const response = await fetch('/api/settings');
          const data = await response.json();
          
          if (data.success && data.settings) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            Object.keys(data.settings).forEach(key => {
              const input = document.getElementById(`setting-${key}`);
              if (input) {
                input.value = data.settings[key] || '';
              }
            });
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
          if (typeof showToast === 'function') {
            showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
          } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
          }
        } finally {
          settingsLoading.style.display = 'none';
          settingsForm.style.display = 'block';
        }
      });
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      function closeSettingsModalFunc() {
        settingsModal.style.display = 'none';
        document.body.style.overflow = '';
      }
      
      closeSettingsModal.addEventListener('click', closeSettingsModalFunc);
      settingsModalOverlay.addEventListener('click', closeSettingsModalFunc);
      if (settingsCancelBtn) {
        settingsCancelBtn.addEventListener('click', closeSettingsModalFunc);
      }
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsModal.style.display === 'flex') {
          closeSettingsModalFunc();
        }
      });
      
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
      if (settingsSaveBtn) {
        settingsSaveBtn.addEventListener('click', async () => {
          try {
            settingsSaveBtn.disabled = true;
            settingsSaveBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã
            const settings = {};
            const inputs = settingsForm.querySelectorAll('[id^="setting-"]');
            inputs.forEach(input => {
              const key = input.id.replace('setting-', '');
              settings[key] = input.value.trim();
            });
            
            const response = await fetch('/api/settings', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ settings })
            });
            
          const data = await response.json();
          
          if (data.success) {
            if (data.restarting) {
              if (typeof showToast === 'function') {
                showToast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...', 'success');
              } else {
                alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...');
              }
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
              settingsLoading.style.display = 'block';
              settingsForm.style.display = 'none';
              
              // –ñ–¥–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
              setTimeout(() => {
                window.location.reload();
              }, 3000);
            } else {
              if (typeof showToast === 'function') {
                showToast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
              } else {
                alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
              }
              setTimeout(() => {
                closeSettingsModalFunc();
              }, 1500);
            }
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
          } finally {
            settingsSaveBtn.disabled = false;
            settingsSaveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
          }
        });
      }
    })();
  </script>
  
  <!-- Navigation Script -->
  <script>
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –æ—á–µ—Ä–µ–¥–µ–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    async function updateQueueNames() {
      const queueSelect = document.getElementById('queue_name');
      if (!queueSelect) return;
      
      try {
        const response = await fetch('/api/queue-names');
        if (response.ok) {
          const queueNames = await response.json();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ–ø—Ü–∏–π –≤ select
          Array.from(queueSelect.options).forEach(option => {
            const queueNumber = option.value;
            if (queueNumber && queueNames[queueNumber]) {
              const formattedName = `${queueNumber} (${queueNames[queueNumber]})`;
              if (option.text !== formattedName) {
                option.text = formattedName;
              }
            }
          });
        }
      } catch (error) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - –Ω–∞–∑–≤–∞–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        console.debug('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π:', error);
      }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      updateQueueNames();
      const viewSelectorBtns = document.querySelectorAll('.view-selector-btn');
      const viewTypeInput = document.getElementById('view_type');
      const queueSelect = document.getElementById('queue_name');
      const startDateInput = document.getElementById('start_date');
      const endDateInput = document.getElementById('end_date');
      const dateRangeInput = document.getElementById('date_range');
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flatpickr –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
      let flatpickrInstance = null;
      if (dateRangeInput) {
        const startDate = startDateInput ? startDateInput.value : '';
        const endDate = endDateInput ? endDateInput.value : '';
        
        flatpickrInstance = flatpickr(dateRangeInput, {
          mode: "range",
          dateFormat: "d.m.Y",
          locale: {
            firstDayOfWeek: 1,
            weekdays: { shorthand: ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"], longhand: ["–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"] },
            months: { shorthand: ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"], longhand: ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"] }
          },
          defaultDate: startDate && endDate ? [startDate, endDate] : null,
          onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 2) {
              const start = selectedDates[0];
              const end = selectedDates[1];
              const startFormatted = start.getFullYear() + '-' + 
                String(start.getMonth() + 1).padStart(2, '0') + '-' + 
                String(start.getDate()).padStart(2, '0');
              const endFormatted = end.getFullYear() + '-' + 
                String(end.getMonth() + 1).padStart(2, '0') + '-' + 
                String(end.getDate()).padStart(2, '0');
              
              if (startDateInput) startDateInput.value = startFormatted;
              if (endDateInput) endDateInput.value = endFormatted;
              
              saveFilters();
            } else if (selectedDates.length === 0) {
              if (startDateInput) startDateInput.value = '';
              if (endDateInput) endDateInput.value = '';
            }
          }
        });
      }
      
      // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
      function saveFilters() {
        const filters = {
          startDate: startDateInput ? startDateInput.value : '',
          endDate: endDateInput ? endDateInput.value : '',
          queue: queueSelect ? queueSelect.value : ''
        };
        localStorage.setItem('asteriskStatsFilters', JSON.stringify(filters));
        return filters;
      }
      
      // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ localStorage
      // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–µ—Ä–≤–µ—Ä–æ–º (–∏–∑ URL)
      function restoreFilters() {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL (—Å–µ—Ä–≤–µ—Ä —É–∂–µ –∏—Ö —É—Å—Ç–∞–Ω–æ–≤–∏–ª)
          const urlParams = new URLSearchParams(window.location.search);
          const hasUrlParams = urlParams.has('start_date') || urlParams.has('end_date') || urlParams.has('queue_name');
          
          // –ï—Å–ª–∏ –≤ URL –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ localStorage
          if (!hasUrlParams) {
            const saved = localStorage.getItem('asteriskStatsFilters');
            if (saved) {
              const filters = JSON.parse(saved);
              if (startDateInput && filters.startDate && !startDateInput.value) {
                startDateInput.value = filters.startDate;
              }
              if (endDateInput && filters.endDate && !endDateInput.value) {
                endDateInput.value = filters.endDate;
              }
              
              // –û–±–Ω–æ–≤–ª—è–µ–º flatpickr –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
              if (flatpickrInstance && filters.startDate && filters.endDate) {
                flatpickrInstance.setDate([filters.startDate, filters.endDate], false);
              }
              // –û—á–µ—Ä–µ–¥—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö
              // –∏ –µ—Å–ª–∏ –º—ã –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–µ–π (–ø–æ–ª–µ –Ω–µ disabled)
              if (queueSelect && filters.queue) {
                const isQueueView = viewTypeInput && (viewTypeInput.value === 'queue' || viewTypeInput.value === 'outbound_queue');
                if (isQueueView || !queueSelect.disabled) {
                  queueSelect.value = filters.queue;
                }
              }
            }
      } else {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –≤ localStorage
            const filters = {
              startDate: startDateInput ? startDateInput.value : '',
              endDate: endDateInput ? endDateInput.value : '',
              queue: queueSelect ? queueSelect.value : ''
            };
            localStorage.setItem('asteriskStatsFilters', JSON.stringify(filters));
      }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', e);
    }
      }
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      restoreFilters();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º flatpickr –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
      if (flatpickrInstance && startDateInput && endDateInput && startDateInput.value && endDateInput.value) {
        flatpickrInstance.setDate([startDateInput.value, endDateInput.value], false);
      }
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
      const urlParams = new URLSearchParams(window.location.search);
      const hasUrlParams = urlParams.has('start_date') || urlParams.has('end_date') || urlParams.has('queue_name');
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL –∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      if (hasUrlParams && form && !document.querySelector('.stats-header-section')) {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ —É—Å–ø–µ–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
        setTimeout(() => {
          if (form.checkValidity()) {
            form.submit();
          }
        }, 100);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
      // (–¥–ª—è date range —ç—Ç–æ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ onChange flatpickr)
      if (queueSelect) {
        queueSelect.addEventListener('change', saveFilters);
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
      const form = document.querySelector('form[action="/report"]');
      viewSelectorBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
          const viewType = this.getAttribute('data-view');
          
          // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–Ω–µ—Ç data-view), –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
          if (!viewType) {
    return;
  }

          e.preventDefault();
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
          const filters = saveFilters();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ view_type
          if (viewTypeInput) {
            viewTypeInput.value = viewType;
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
          if (startDateInput && filters.startDate) {
            startDateInput.value = filters.startDate;
          }
          if (endDateInput && filters.endDate) {
            endDateInput.value = filters.endDate;
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º flatpickr
          if (flatpickrInstance && filters.startDate && filters.endDate) {
            flatpickrInstance.setDate([filters.startDate, filters.endDate], false);
          }
          
          // –£–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—è –æ—á–µ—Ä–µ–¥–∏
          if (queueSelect) {
            if (viewType === 'queue' || viewType === 'outbound_queue') {
              // –î–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
              queueSelect.removeAttribute('disabled');
              queueSelect.setAttribute('required', 'required');
              // –í—Å–µ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
              if (filters.queue) {
                queueSelect.value = filters.queue;
              }
            } else {
              // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
              queueSelect.setAttribute('disabled', 'disabled');
              queueSelect.removeAttribute('required');
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
              if (queueSelect.value) {
                filters.queue = queueSelect.value;
                localStorage.setItem('asteriskStatsFilters', JSON.stringify(filters));
              }
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ
          viewSelectorBtns.forEach(b => {
            b.classList.remove('active');
            b.setAttribute('aria-pressed', 'false');
          });
          this.classList.add('active');
          this.setAttribute('aria-pressed', 'true');
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
          if (form) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            if (form.checkValidity()) {
              form.submit();
            } else {
              // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
              form.reportValidity();
        }
      }
    });
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const currentViewType = viewTypeInput ? viewTypeInput.value : 'queue';
      if (queueSelect) {
        if (currentViewType !== 'queue' && currentViewType !== 'outbound_queue') {
          queueSelect.setAttribute('disabled', 'disabled');
          queueSelect.removeAttribute('required');
        } else {
          queueSelect.removeAttribute('disabled');
          queueSelect.setAttribute('required', 'required');
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∏–∑ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—á–µ—Ä–µ–¥–µ–π
          const saved = localStorage.getItem('asteriskStatsFilters');
          if (saved) {
            try {
              const filters = JSON.parse(saved);
              if (filters.queue && !queueSelect.value) {
                queueSelect.value = filters.queue;
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏:', e);
            }
          }
        }
      }
      
      // –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–∞—Ç
      const quickFilterBtns = document.querySelectorAll('button[data-period]');
      quickFilterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const period = this.getAttribute('data-period');
          
          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
          quickFilterBtns.forEach(b => {
            b.classList.remove('active');
          });
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
          this.classList.add('active');
          const today = new Date();
          let startDate, endDate;
          
          switch(period) {
            case 'today':
              startDate = endDate = today.toISOString().split('T')[0];
              break;
            case 'yesterday':
              const yesterday = new Date(today);
              yesterday.setDate(yesterday.getDate() - 1);
              startDate = endDate = yesterday.toISOString().split('T')[0];
              break;
            case 'week':
              const weekStart = new Date(today);
              weekStart.setDate(today.getDate() - 7);
              startDate = weekStart.toISOString().split('T')[0];
              endDate = today.toISOString().split('T')[0];
              break;
            case 'month':
              const monthStart = new Date(today);
              monthStart.setDate(today.getDate() - 30);
              startDate = monthStart.toISOString().split('T')[0];
              endDate = today.toISOString().split('T')[0];
              break;
            default:
              return;
          }
          
          if (startDateInput) startDateInput.value = startDate;
          if (endDateInput) endDateInput.value = endDate;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º flatpickr
          if (flatpickrInstance && startDate && endDate) {
            flatpickrInstance.setDate([startDate, endDate], false);
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
          quickFilterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
          saveFilters();
        });
      });
      
      // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
      const exportBtn = document.getElementById('export-btn');
      if (exportBtn) {
        exportBtn.addEventListener('click', async function() {
          <% if (typeof results !== 'undefined' && results && results.calls) { %>
          const format = confirm('–ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel (XLSX) –∏–ª–∏ –û—Ç–º–µ–Ω–∞ –¥–ª—è CSV');
          
          if (format) {
            // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
            try {
              const startDateInput = document.getElementById('start_date');
              const endDateInput = document.getElementById('end_date');
              const queueSelect = document.getElementById('queue_name');
              const viewTypeInput = document.getElementById('view_type');
              
              const startDate = (startDateInput && startDateInput.value) ? startDateInput.value.trim() : '';
              const endDate = (endDateInput && endDateInput.value) ? endDateInput.value.trim() : '';
              const queueName = (queueSelect && queueSelect.value) ? queueSelect.value.trim() : '';
              const viewType = (viewTypeInput && viewTypeInput.value) ? viewTypeInput.value.trim() : 'queue';
              
              if (!startDate || !endDate) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞. –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è: start=' + startDate + ', end=' + endDate);
                return;
              }
              
              console.log('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:', { startDate, endDate, queueName, viewType });
              
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º URLSearchParams –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
              const formData = new URLSearchParams();
              formData.append('queue_name', queueName || '');
              formData.append('start_date', startDate);
              formData.append('end_date', endDate);
              formData.append('view_type', viewType);
              
              console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', formData.toString());
              
              const response = await fetch('/export-report-excel', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
              });
              
              if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏–ª–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–∞–º–∏
                let downloadFilename = 'export.xlsx';
                const contentDisposition = response.headers.get('Content-Disposition');
                if (contentDisposition) {
                  // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ filename*=UTF-8''
                  const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+?)(?:;|$)/);
                  if (utf8Match) {
                    try {
                      downloadFilename = decodeURIComponent(utf8Match[1]);
                    } catch (e) {
                      // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
                      downloadFilename = utf8Match[1];
                    }
                  } else {
                    // –ò–ª–∏ –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ filename
                    const filenameMatch = contentDisposition.match(/filename="?(.+?)"?\s*(?:;|$)/);
                    if (filenameMatch) {
                      downloadFilename = filenameMatch[1];
                    }
                  }
                }
                
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Å–∞–º–∏
                if (downloadFilename === 'export.xlsx') {
                  if (viewType === 'queue') {
                    downloadFilename = `–û—á–µ—Ä–µ–¥—å_${queueName}_${startDate}_${endDate}.xlsx`;
                  } else if (viewType === 'outbound_queue') {
                    downloadFilename = `–ò—Å—Ö_–æ—á–µ—Ä–µ–¥—å_${queueName}_${startDate}_${endDate}.xlsx`;
                  } else if (viewType === 'inbound') {
                    downloadFilename = `–í—Ö–æ–¥—è—â–∏–µ_${startDate}_${endDate}.xlsx`;
                  } else {
                    downloadFilename = `–ò—Å—Ö–æ–¥—è—â–∏–µ_${startDate}_${endDate}.xlsx`;
                  }
                }
                
                a.download = downloadFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
              } else {
                const error = await response.json();
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
              }
            } catch (error) {
              alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
            }
          } else {
            // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)
          const calls = <%- JSON.stringify(results.calls) %>;
          const stats = <%- JSON.stringify(results.stats) %>;
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º CSV
          // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–∞–π–º–∑–æ–Ω—ã (–¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
          const formatDateTimeCSV = (dateString) => {
            if (!dateString) return '';
            const str = dateString.toString();
            const match = str.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/);
            if (match) return `${match[3]}.${match[2]}.${match[1]} ${match[4]}:${match[5]}`;
            return str;
          };
          
          let csv = '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è,–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞,–°—Ç–∞—Ç—É—Å,–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫),–û–∂–∏–¥–∞–Ω–∏–µ (—Å–µ–∫),–ê–≥–µ–Ω—Ç\n';
          calls.forEach(call => {
            const date = formatDateTimeCSV(call.startTime);
            // –î–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º destination (–¥–ª–∏–Ω–Ω—ã–π –Ω–æ–º–µ—Ä), –µ—Å–ª–∏ –æ–Ω –¥–ª–∏–Ω–Ω–µ–µ src
            const minLength = 4;
            const srcLen = call.clientNumber ? call.clientNumber.toString().trim().length : 0;
            const dstLen = call.destination ? call.destination.toString().trim().length : 0;
            const isShortToLong = srcLen > 0 && dstLen > 0 && srcLen <= minLength && dstLen > minLength;
            const isDstLonger = srcLen > 0 && dstLen > 0 && dstLen > srcLen;
            const number = (isShortToLong || isDstLonger) && call.destination 
              ? (call.destination || call.clientNumber || '') 
              : (call.clientNumber || '');
            const status = call.status || '';
            const duration = call.duration || 0;
            const waitTime = call.waitTime || 0;
            const agent = call.agent || '';
            csv += `"${date}","${number}","${status}",${duration},${waitTime},"${agent}"\n`;
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          csv += '\n=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===\n';
          csv += `–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤,${stats.totalCalls}\n`;
          csv += `–ü—Ä–∏–Ω—è—Ç–æ,${stats.answeredCalls}\n`;
          csv += `–ü—Ä–æ–ø—É—â–µ–Ω–æ,${stats.abandonedCalls}\n`;
          csv += `–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞,${stats.answerRate}%\n`;
          csv += `SLA (20 —Å–µ–∫),${stats.slaRate}%\n`;
          
          // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
          const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `asterisk-stats-${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          }
          <% } else { %>
          alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑.');
<% } %>
        });
      }
    });
  </script>

  <!-- Technical monitoring script -->
  <script>
    // Performance monitoring
    window.addEventListener('load', () => {
      console.log('üöÄ Asterisk Analytics Dashboard loaded');
      console.log('üìä Technical metrics initialized');

      // Monitor page performance
      if ('performance' in window) {
        const perfData = performance.getEntriesByType('navigation')[0];
        console.log(`‚ö° Page load time: ${Math.round(perfData.loadEventEnd - perfData.fetchStart)}ms`);
      }
    });

    // Error monitoring
    window.addEventListener('error', (e) => {
      console.error('üî• Application error:', e.error);
    });

    // Audio playback function
    function playRecording(filename) {
      console.log('üéµ Playing recording:', filename);
      // Implementation in chart.js
    }

    // Generate hourly SVG chart
    function generateHourlyChart() {
      const hourlyDataEl = document.getElementById('hourly-data');
      if (!hourlyDataEl) return;

      const hourlyData = JSON.parse(hourlyDataEl.getAttribute('data-hourly'));
      const chartContainer = document.getElementById('hourly-chart');
      if (!chartContainer) return;

      // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      const containerWidth = chartContainer.parentElement.offsetWidth || 1200;
      const width = Math.max(containerWidth - 40, 800); // –ú–∏–Ω–∏–º—É–º 800px, –≤—ã—á–∏—Ç–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
      const height = 300; // –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞
      const padding = { top: 20, right: 20, bottom: 50, left: 60 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      const barWidth = chartWidth / 24;
      // –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º answered + noCallbacks (–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω)
      const maxValue = Math.max(...Object.values(hourlyData).map(h => {
        const noCallbacks = h.noCallbacks !== undefined ? h.noCallbacks : (h.abandoned || 0);
        return (h.answered || 0) + noCallbacks;
      }), 1);
      const gridLines = 5;

      let svg = `<svg class="hourly-chart-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="hourlyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#0061a6;stop-opacity:1"></stop>
            <stop offset="100%" style="stop-color:#004d84;stop-opacity:1"></stop>
          </linearGradient>
          <linearGradient id="answeredGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1"></stop>
            <stop offset="100%" style="stop-color:#059669;stop-opacity:1"></stop>
          </linearGradient>
        </defs>

        <!-- Grid lines -->`;

      // Grid lines
      svg += '<g class="grid-lines">';
      for (let i = 0; i <= gridLines; i++) {
        const y = padding.top + (chartHeight / gridLines) * i;
        const value = Math.round(maxValue - (maxValue / gridLines) * i);
        svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="rgba(148, 163, 184, 0.15)" stroke-width="1" stroke-dasharray="2,2"></line>`;
        svg += `<text x="${padding.left - 5}" y="${y + 4}" text-anchor="end" fill="#64748b" font-size="10" style="transition: opacity 0.3s 0.2s; opacity: 1;">${value}</text>`;
      }
      svg += '</g>';

      // Calculate trend line (moving average for smoother visualization)
      const trendPoints = [];
      const windowSize = 3; // 3-hour moving average
      for (let hour = 0; hour < 24; hour++) {
        let sum = 0;
        let count = 0;
        for (let i = Math.max(0, hour - Math.floor(windowSize / 2)); i <= Math.min(23, hour + Math.floor(windowSize / 2)); i++) {
          const data = hourlyData[i] || { total: 0, answered: 0, noCallbacks: 0 };
          const noCallbacks = data.noCallbacks !== undefined ? data.noCallbacks : (data.abandoned || 0);
          const hourTotal = (data.answered || 0) + noCallbacks;
          sum += hourTotal;
          count++;
        }
        const avg = count > 0 ? sum / count : 0;
        trendPoints.push({
          hour: hour,
          value: avg,
          x: padding.left + (barWidth * hour) + (barWidth / 2),
          y: padding.top + chartHeight - (avg / maxValue) * chartHeight
        });
      }

      // Bars (stacked: answered bottom, noCallbacks top)
      svg += '<g class="bars">';
      for (let hour = 0; hour < 24; hour++) {
        const data = hourlyData[hour] || { total: 0, answered: 0, abandoned: 0, noCallbacks: 0 };
        const x = padding.left + (barWidth * hour);
        const baseY = padding.top + chartHeight;
        
        // Answered bar (bottom, blue gradient)
        const answeredHeight = data.answered > 0 ? (data.answered / maxValue) * chartHeight : 0;
        const answeredY = baseY - answeredHeight;
        
        // "–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω" bar (top, orange/red) - –∏—Å–ø–æ–ª—å–∑—É–µ–º noCallbacks –≤–º–µ—Å—Ç–æ abandoned
        const noCallbacksValue = data.noCallbacks !== undefined ? data.noCallbacks : data.abandoned;
        const noCallbacksHeight = noCallbacksValue > 0 ? (noCallbacksValue / maxValue) * chartHeight : 0;
        const noCallbacksY = answeredY - noCallbacksHeight;
        
        const isPeak = data.total === maxValue && data.total > 0;

        svg += `<g class="hour-bar" data-hour="${hour}" data-total="${data.total}" data-answered="${data.answered}" data-abandoned="${noCallbacksValue}">`;
        
        // Answered bar (blue gradient) - bottom part
        if (data.answered > 0) {
          const answeredFill = isPeak ? '#0061a6' : 'url(#hourlyGradient)';
          svg += `<rect x="${x}" y="${answeredY}" width="${barWidth - 2}" height="${answeredHeight}" fill="${answeredFill}" rx="2" ry="2" style="opacity: 1; transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);" class="bar-rect bar-answered"></rect>`;
        }
        
        // "–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω" bar (orange) - top part
        if (noCallbacksValue > 0) {
          const noCallbacksFill = isPeak ? '#f59e0b' : '#f59e0b';
          svg += `<rect x="${x}" y="${noCallbacksY}" width="${barWidth - 2}" height="${noCallbacksHeight}" fill="${noCallbacksFill}" rx="2" ry="2" style="opacity: 1; transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);" class="bar-rect bar-abandoned"></rect>`;
        }
        
        // Total label on top
        if (data.total > 0) {
          const labelY = noCallbacksY > 0 ? noCallbacksY - 5 : (answeredY > 0 ? answeredY - 5 : baseY - 5);
          svg += `<text x="${x + barWidth / 2}" y="${labelY}" text-anchor="middle" fill="#64748b" font-size="9" font-weight="600" style="opacity: 1; transition: opacity 0.3s 0.2s;">${data.total}</text>`;
        }
        
        svg += '</g>';
      }
      svg += '</g>';

      // Draw trend line AFTER bars (so it appears on top)
      svg += '<g class="trend-line">';
      let trendPath = '';
      trendPoints.forEach((point, index) => {
        if (index === 0) {
          trendPath += `M ${point.x} ${point.y}`;
        } else {
          trendPath += ` L ${point.x} ${point.y}`;
        }
      });
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏—Ä—é–∑–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ —Å —Å–∏–Ω–∏–º –∏ –æ—Ä–∞–Ω–∂–µ–≤—ã–º
      svg += `<path d="${trendPath}" fill="none" stroke="#06b6d4" stroke-width="3" stroke-dasharray="5,3" opacity="1" class="trend-path"></path>`;
      
      // Add trend line points
      trendPoints.forEach(point => {
        if (point.value > 0) {
          svg += `<circle cx="${point.x}" cy="${point.y}" r="4" fill="#06b6d4" opacity="1" stroke="#ffffff" stroke-width="1.5" class="trend-point"></circle>`;
        }
      });
      svg += '</g>';
      
      // Legend
      svg += '<g class="chart-legend">';
      const legendY = padding.top - 10;
      svg += `<circle cx="${padding.left + 20}" cy="${legendY}" r="5" fill="url(#hourlyGradient)"></circle>`;
      svg += `<text x="${padding.left + 30}" y="${legendY + 4}" fill="#64748b" font-size="10">–û—Ç–≤–µ—á–µ–Ω–Ω—ã–µ</text>`;
      svg += `<circle cx="${padding.left + 120}" cy="${legendY}" r="5" fill="#f59e0b"></circle>`;
      svg += `<text x="${padding.left + 130}" y="${legendY + 4}" fill="#64748b" font-size="10">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</text>`;
      svg += `<line x1="${padding.left + 220}" y1="${legendY}" x2="${padding.left + 240}" y2="${legendY}" stroke="#06b6d4" stroke-width="3" stroke-dasharray="5,3" opacity="1"></line>`;
      svg += `<text x="${padding.left + 245}" y="${legendY + 4}" fill="#64748b" font-size="10">–¢—Ä–µ–Ω–¥</text>`;
      svg += '</g>';

      // Hour labels
      const labelHours = [0, 3, 6, 9, 12, 15, 18, 21];
      labelHours.forEach(hour => {
        const x = padding.left + (barWidth * hour) + (barWidth / 2);
        const label = hour.toString().padStart(2, '0') + ':00';
        svg += `<text x="${x}" y="${height - 10}" text-anchor="middle" fill="#64748b" font-size="10" font-weight="500" style="transition: opacity 0.3s 0.2s; opacity: 1;">${label}</text>`;
      });

      svg += '</svg>';
      chartContainer.innerHTML = svg;
      
      // Add tooltip event listeners
      setupChartTooltips();
    }
    
    // Setup tooltip for chart bars
    function setupChartTooltips() {
      const tooltip = document.getElementById('chart-tooltip');
      if (!tooltip) return;
      
      const hourBars = document.querySelectorAll('.hour-bar');
      const chartContainer = document.querySelector('.hourly-chart-container');
      
      hourBars.forEach(bar => {
        const rects = bar.querySelectorAll('rect');
        
        rects.forEach(rect => {
          rect.addEventListener('mouseenter', (e) => {
            const hour = parseInt(bar.getAttribute('data-hour'));
            const total = parseInt(bar.getAttribute('data-total'));
            const answered = parseInt(bar.getAttribute('data-answered'));
            const abandoned = parseInt(bar.getAttribute('data-abandoned'));
            
            if (total === 0) return;
            
            // Update tooltip content
            document.getElementById('tooltip-time').textContent = `${hour.toString().padStart(2, '0')}:00`;
            document.getElementById('tooltip-total').textContent = total;
            document.getElementById('tooltip-answered').textContent = answered;
            document.getElementById('tooltip-abandoned').textContent = abandoned;
            
            // Show tooltip
            tooltip.style.display = 'block';
            
            // Position tooltip
            updateTooltipPosition(e, tooltip, chartContainer);
          });
          
          rect.addEventListener('mousemove', (e) => {
            if (tooltip.style.display === 'block') {
              updateTooltipPosition(e, tooltip, chartContainer);
            }
          });
          
          rect.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
          });
        });
      });
    }
    
    function updateTooltipPosition(e, tooltip, container) {
      const containerRect = container.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      
      let x = e.clientX - containerRect.left + 10;
      let y = e.clientY - containerRect.top - tooltipRect.height - 10;
      
      // Adjust if tooltip goes outside container
      if (x + tooltipRect.width > containerRect.width) {
        x = e.clientX - containerRect.left - tooltipRect.width - 10;
      }
      if (y < 0) {
        y = e.clientY - containerRect.top + 10;
      }
      
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }

    // Initialize chart on load
    if (document.getElementById('hourly-data')) {
      generateHourlyChart();
    }
  </script>
</body>
</html>